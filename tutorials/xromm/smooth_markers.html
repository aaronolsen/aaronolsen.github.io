<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<title>Smooth markers</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" >
<link rel="shortcut icon" href="../../img/favicon.png"/>
<link href="../../css/stylesheet2.css" rel="stylesheet" type="text/css">

<body>
	<div id='container' class='container'>

		<div id='header' class='header' >
			<div style='position:relative;' >
				<img id='header_image' style='float:right;' src='../../img/headers/Hairy Woodpecker.jpg' />
				<div id='header_image_caption' style='color:white' class='header_image_caption' >
					Hairy Woodpecker
				</div>
			</div>
		</div>

		<div id='linksidebar' class='linksidebar' >
			<div class='linksidebar_mainlink' >
				<a class='linksidebar_link' href='../../about_me.html'>About me</a>
			</div>
			<div class='linksidebar_mainlink' >
				<a class='linksidebar_link' href='../../current_projects.html'>Current projects</a>
			</div>
			<div class='linksidebar_mainlink' >
				<a class='linksidebar_link' href='../../software.html'>Software</a>
			</div>
			<div class='linksidebar_mainlink' >
				<a class='linksidebar_link' href='../../tutorials/visualization3d.html'>Tutorials</a>
			</div>
			<div class='linksidebar_sublink' >
				<a class='linksidebar_link' href='../../tutorials/visualization3d.html'>3D Visualization</a>
			</div>
			<div class='linksidebar_sublink' >
				<a class='linksidebar_link' href='../../tutorials/morphometrics.html'>Shape analysis</a>
			</div>
			<div class='linksidebar_sublink' >
				<a class='linksidebar_link' href='../../tutorials/xromm.html'>XROMM</a>
			</div>
			<div class='linksidebar_sub2link_u' >
				<a class='linksidebar_link_u' href='../../tutorials/xromm/smooth_markers.html'>Smooth markers</a>
			</div>
			<div class='linksidebar_sub2link' >
				<a class='linksidebar_link' href='../../tutorials/xromm/segmenting_ct.html'>Segmentation</a>
			</div>
			<div class='linksidebar_sublink' >
				<a class='linksidebar_link' href='../../tutorials/mechanisms.html'>Mechanism models</a>
			</div>
			<div class='linksidebar_sublink' >
				<a class='linksidebar_link' href='../../tutorials/stereomorph.html'>StereoMorph User Guide</a>
			</div>
			<div class='linksidebar_sublink' >
				<a class='linksidebar_link' href='../../tutorials/knex/large_u_joint.html'>K'nex models</a>
			</div>
			<div class='linksidebar_mainlink' >
				<a class='linksidebar_link' href='../../contact.html'>Contact</a>
			</div>
			<div class='linksidebar_mainlink' >
				<a class='linksidebar_link' href='../../cv.html'>CV</a>
			</div>
		</div>

		<div id='maincontent' class='maincontent' >

			<div id='pagetrail' class='pagetrail' ><a href="../../about_me.html">home</a>&nbsp;&nbsp;&nbsp;>&nbsp;&nbsp;&nbsp;<a href="../../tutorials/visualization3d.html">tutorials</a>&nbsp;&nbsp;&nbsp;>&nbsp;&nbsp;&nbsp;<a href="../../tutorials/xromm.html">xromm</a>&nbsp;&nbsp;&nbsp;>&nbsp;&nbsp;&nbsp;smooth markers</div>


<div class='maincontentfill'>
<h1>Smooth markers</h1>

<p>
Raw animated 3D markers used in motion analysis or rigid body animation have some level of 
noise due mostly to digitizing or tracking errors. 
This tutorial will show you how to smooth the trajectories of tracked markers over time to 
remove this noise and create smooth plotted trajectories and animations.
The uninterrupted block of code can be found at the <a href="#uninterrupted_code">end of this tutorial</a>.
</p><h2>Preliminary steps</h2><p>Make sure that you have 
		<a href="http://rweb.quant.ku.edu/cran/" target="_blank" >R</a> 
		installed on your system (you can find R installation instructions 
		<a href="https://cran.r-project.org" target="_blank" >here</a>). Next, install the beta version (v1.3.1) of the R package svgViewR. 
		You can do this by downloading 
		<a href="https://minhaskamal.github.io/DownGit/#/home?url=https://github.com/aaronolsen/svgViewR" target="_blank" >this folder</a> 
		(< 1MB), unzipping the contents, 
		and then running the two commands below to load the functions into your current R environment.</p>

		<div class="code" ><pre class="code">
<span class="code_comment" ># Set the path to where the package was downloaded (customize this to your system)</span>
pkg_path <- <span class="code_quote" >'/Users/aaron/Downloads/svgViewR-master/R'</span>

<span class="code_comment" ># Load all functions in this folder into the global environment</span>
source_apply <- <span class="code_function" >sapply</span>(<span class="code_function" >paste0</span>(pkg_path, <span class="code_quote" >'/'</span>, <span class="code_function" >list.files</span>(<span class="code_function" >paste0</span>(pkg_path, <span class="code_quote" >''</span>))), source, .GlobalEnv)
</pre></div>
		Next, install the beta version (v1.0) of the R package matools (not yet on CRAN). 
		You can do this by downloading 
		<a href="https://minhaskamal.github.io/DownGit/#/home?url=https://github.com/aaronolsen/matools" target="_blank" >this folder</a> 
		(< 1MB), unzipping the contents, 
		and then running the two commands below to load the functions into your current R environment.</p>

		<div class="code" ><pre class="code">
<span class="code_comment" ># Set the path to where the package was downloaded (customize this to your system)</span>
pkg_path <- <span class="code_quote" >'/Users/aaron/Downloads/matools-master/R'</span>

<span class="code_comment" ># Load all functions in this folder into the global environment</span>
source_apply <- <span class="code_function" >sapply</span>(<span class="code_function" >paste0</span>(pkg_path, <span class="code_quote" >'/'</span>, <span class="code_function" >list.files</span>(<span class="code_function" >paste0</span>(pkg_path, <span class="code_quote" >''</span>))), source, .GlobalEnv)
</pre></div>
		<h2>Non-adaptive smoothing</h2>

<p>
To smooth a set of 3D coordinates you'll need an array of coordinates (in which the third dimension 
is the position of each coordinate over time). 
This can be a '3D Points' file exported from <a href='https://bitbucket.org/xromm/xmalab/wiki/Home' target='_blank' >XMALab</a>, for example. 
</p>
<p>
You can try out the code in this tutorial using this 
<a href='Nov 17 2016 Cat 01 Trial 09.csv' target='_blank' >unsmoothed 3D marker coordinates</a> file. 
This file contains the 3D coordinates of radiopaque markers implanted in a 
channel catfish eating a worm, captured using <a href='http://xromm.org/' target='_blank' >XROMM</a>, 
tracked using <a href='https://bitbucket.org/xromm/xmalab/wiki/Home' target='_blank' >XMALab</a>. 
This tutorial file also contains extra metadata associated with the trial (e.g. calibration, frame number, etc.), 
though we are just interested in the marker coordinates at this point. 
Download the file and move it to your current R working directory and then read the animated 
coordinates from the file using the 'readMotion' function ('matools' package).
</p>

<div class="code" ><pre class="code">
<span class="code_comment" ># Read unsmoothed motion</span>
read_motion <- <span class="code_function" >readMotion</span>(<span class="code_quote" >'Nov 17 2016 Cat 01 Trial 09.csv'</span>)
</pre></div>

<p>
The 'readMotion' function returns a 'motion' object containing the marker coordinates ($xyz) 
and the additional metadata. You can preview the contents of this object using the 'print' function. 
The output of the 'print' command shows you the number of iterations (i.e. "time points") in the motion object (here, 1819), 
the names of the "xyz" (i.e. marker) coordinates, and all of the metadata columns ("calibration", "frame", etc.).
</p>

<div class="code" ><pre class="code">
<span class="code_comment" ># See what is contained in the motion object</span>
<span class="code_function" >print</span>(read_motion)
</pre></div>

<p>
Next input this motion object into 'smoothMotion'. 
We'll start with the simplest type of call to 'smoothMotion' in which a single smoothing parameter 
is applied across the entire time sequence (non-adaptive smoothing). 
Include a file path where you would like to save a PDF diagnostic plot using the 'plot.diag' parameter; 
the diagnostic plot is essential to making sure you have selected an appropriate degree of smoothing.
</p>

<div class="code" ><pre class="code">
<span class="code_comment" ># Smooth points in the motion object</span>
points_smooth <- <span class="code_function" >smoothMotion</span>(read_motion, plot.diag=<span class="code_quote" >'Nov 17 2016 Cat 01 Trial 09.pdf'</span>)
</pre></div>

<p>
Note that 'smoothMotion' can also accept a simple 3D point array instead of a motion object. For example, 
this also works:
</p>

<div class="code" ><pre class="code">
<span class="code_comment" ># smoothMotion also accepts a simple 3D point array</span>
points_smooth <- <span class="code_function" >smoothMotion</span>(read_motion$xyz, plot.diag=<span class="code_quote" >'Nov 17 2016 Cat 01 Trial 09.pdf'</span>)
</pre></div>

<p>
Take a look at the diagnostic plot output by 'smoothMotion'. 
For each marker coordinate 'smoothMotion' creates two plots side-by-side: 
(1) the raw and smoothed x-, y-, and z-values over time (mean-centered so they fit nicely in the same plot) and 
(2) the deviation of the smoothed values from the raw values over time. 
Note that since this tutorial file has 38 marker coordinates this is a fairly "tall" PDF. 
Below is a close-up at just the first row, for the 'Epaxial_bead_cra' marker (a marker implanted in the 
cranial portion of the epaxial or back muscles of the catfish).
</p>

<div class='p_image_middle_div' style="width:750px;">
	<div><a href='../../img/tutorials/xromm/smoothMotion diagnostic first row.jpg' target='_blank'>
		<img width='750px' src='../../img/tutorials/xromm/smoothMotion diagnostic first row.jpg' /></a></div>
	<div class='p_image_caption' style='text-align:center;' >
		Diagnostic plots created by 'smoothMotion' for each marker showing the raw and 
		smoothed values (left) and the deviation of the smoothed from the raw values (right).
	</div>
</div>

<p>
If you zoom into the left plot of the PDF you can see the smoothed xyz-values (darker, thinner line) superimposed on the raw xyz-values.
</p>

<div class='p_image_middle_div' style="width:500px;">
	<div><a href='../../img/tutorials/xromm/smoothMotion diagnostic values closeup.jpg' target='_blank'>
		<img width='500px' src='../../img/tutorials/xromm/smoothMotion diagnostic values closeup.jpg' /></a></div>
	<div class='p_image_caption' style='text-align:center;' >
		Close-up of smoothed xyz coordinates (darker) superimposed on raw (lighter) coordinates. 
		Smoothed values miss some consistent trends in the raw values.
	</div>
</div>

<p>
The smoothing looks pretty good but there are some areas where there is a consistent trend 
in the raw coordinates that is not evident in the smoothed coordinates. This is especially evident when 
looking at the deviation of the smoothed coordinates over time.
</p>

<div class='p_image_middle_div' style="width:400px;">
	<div><a href='../../img/tutorials/xromm/smoothMotion diagnostic deviation closeup.jpg' target='_blank'>
		<img width='400px' src='../../img/tutorials/xromm/smoothMotion diagnostic deviation closeup.jpg' /></a></div>
	<div class='p_image_caption' style='text-align:center;' >
		A close-up of deviation of smoothed coordinates from raw coordinates. 
		Broad peaks (more than 1-2 frames) suggest excessive smoothing.
	</div>
</div>

<p>
The 'smoothMotion' function smoothes each dimension of each marker using the 
<a href='https://stat.ethz.ch/R-manual/R-devel/library/stats/html/loess.html' target='_blank' >'loess' function</a> (R 'stats' package). 
The 'loess' function uses polynomial fitting with degree of smoothing controlled by the parameter 'span'. 
The degree of smoothing with 'loess' depends on the length of the time sequence so 'span' must be adjusted 
as the time sequence increases or decreases. The 'smoothMotion' function performs this adjustment for you but 
you can still specify the degree of smoothing using the 'span.factor' parameter. 
The default value for this parameter is 18; this is a value that I have found to work well 
using different motion datasets but you may need to adjust this value.
</p>


smoothMotion diagnostic first row

<br /><br />
</div><h2>Uninterrupted code</h2><a name="uninterrupted_code" ></a><br /><div class="code" ><pre class="code">
<span class="code_comment" ># Set the path to where the package was downloaded (customize this to your system)</span>
pkg_path <- <span class="code_quote" >'/Users/aaron/Downloads/svgViewR-master/R'</span>

<span class="code_comment" ># Load all functions in this folder into the global environment</span>
source_apply <- <span class="code_function" >sapply</span>(<span class="code_function" >paste0</span>(pkg_path, <span class="code_quote" >'/'</span>, <span class="code_function" >list.files</span>(<span class="code_function" >paste0</span>(pkg_path, <span class="code_quote" >''</span>))), source, .GlobalEnv)

<span class="code_comment" ># Set the path to where the package was downloaded (customize this to your system)</span>
pkg_path <- <span class="code_quote" >'/Users/aaron/Downloads/matools-master/R'</span>

<span class="code_comment" ># Load all functions in this folder into the global environment</span>
source_apply <- <span class="code_function" >sapply</span>(<span class="code_function" >paste0</span>(pkg_path, <span class="code_quote" >'/'</span>, <span class="code_function" >list.files</span>(<span class="code_function" >paste0</span>(pkg_path, <span class="code_quote" >''</span>))), source, .GlobalEnv)

<span class="code_comment" ># Read unsmoothed motion</span>
read_motion <- <span class="code_function" >readMotion</span>(<span class="code_quote" >'Nov 17 2016 Cat 01 Trial 09.csv'</span>)

<span class="code_comment" ># See what is contained in the motion object</span>
<span class="code_function" >print</span>(read_motion)

<span class="code_comment" ># Smooth points in the motion object</span>
points_smooth <- <span class="code_function" >smoothMotion</span>(read_motion, plot.diag=<span class="code_quote" >'Nov 17 2016 Cat 01 Trial 09.pdf'</span>)

<span class="code_comment" ># smoothMotion also accepts a simple 3D point array</span>
points_smooth <- <span class="code_function" >smoothMotion</span>(read_motion$xyz, plot.diag=<span class="code_quote" >'Nov 17 2016 Cat 01 Trial 09.pdf'</span>)
</pre></div>
		</div>

		<div id='footer' class='footer' >
			<div style='float:left;' >© 2018 Aaron Olsen. All rights reserved.<br><br></div>
			<div style='float:right;' >Design and photographs by Aaron Olsen.</div>
			<div style='float:left;background-color:;' >The material on this site is based upon work supported by the National Science Foundation (DGE-1144082, DGE-0903637, DBI-1612230). Any opinions, findings, and conclusions or recommendations expressed in this material are those of the author(s) and do not necessarily reflect the views of the National Science Foundation.</div>
		</div>

	</div>

</body>
<script src="../../js/sharedfunctions2.js" type="text/javascript" ></script>