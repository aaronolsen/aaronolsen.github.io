<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<title>Linkage Viewer</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" >

<svg_doc xmlns="http://www.w3.org/2000/svg" version="1.1" style="visibility:hidden;" >
	<circle z-index="0" layer="" cx="0" cy="0.5" cz="0.5" label="" r="4" stroke="black" stroke-width="2" fill="white" fill-opacity="1" stroke-opacity="1"  />
	<circle z-index="0" layer="" cx="0.5" cy="1.1" cz="0.5" label="" r="4" stroke="black" stroke-width="2" fill="white" fill-opacity="1" stroke-opacity="1" animate="0.5 1.1 0.5, 0.50239741 1.09799382 0.49952052, 0.50478677 1.09597768 0.49904265, 0.50716804 1.09395161 0.49856639, 0.50954119 1.09191565 0.49809176, 0.51190616 1.08986983 0.49761877, 0.51426293 1.08781417 0.49714741, 0.51661145 1.08574873 0.49667771, 0.51895168 1.08367353 0.49620966, 0.52128359 1.0815886 0.49574328, 0.52360713 1.07949398 0.49527857, 0.52592228 1.07738971 0.49481554, 0.52822898 1.07527582 0.4943542, 0.5305272 1.07315235 0.49389456, 0.5328169 1.07101933 0.49343662, 0.53509805 1.06887679 0.49298039, 0.5373706 1.06672478 0.49252588, 0.53963452 1.06456333 0.4920731, 0.54188977 1.06239247 0.49162205, 0.54413631 1.06021224 0.49117274, 0.54637411 1.05802268 0.49072518, 0.54860313 1.05582382 0.49027937, 0.55082332 1.0536157 0.48983534, 0.55303466 1.05139836 0.48939307, 0.55523711 1.04917184 0.48895258, 0.55743063 1.04693616 0.48851387, 0.55961518 1.04469137 0.48807696, 0.56179073 1.04243751 0.48764185, 0.56395724 1.04017461 0.48720855, 0.56611467 1.03790271 0.48677707, 0.568263 1.03562185 0.4863474, 0.57040218 1.03333207 0.48591956, 0.57253217 1.0310334 0.48549357, 0.57465295 1.02872589 0.48506941, 0.57676447 1.02640957 0.48464711, 0.57886671 1.02408447 0.48422666, 0.58095962 1.02175065 0.48380808, 0.58304318 1.01940813 0.48339136, 0.58511734 1.01705696 0.48297653, 0.58718207 1.01469718 0.48256359, 0.58923734 1.01232882 0.48215253, 0.59128312 1.00995193 0.48174338, 0.59331936 1.00756654 0.48133613, 0.59534605 1.00517269 0.48093079, 0.59736313 1.00277043 0.48052737, 0.59937058 1.0003598 0.48012588, 0.60136837 0.99794082 0.47972633, 0.60335646 0.99551355 0.47932871, 0.60533481 0.99307803 0.47893304, 0.60730341 0.99063429 0.47853932" />
	<circle z-index="0" layer="" cx="1" cy="0.7" cz="0" label="" r="4" stroke="black" stroke-width="2" fill="white" fill-opacity="1" stroke-opacity="1" animate="1 0.7 0, 1.00558141 0.7 0.00111628, 1.01111947 0.7 0.00222389, 1.01661489 0.7 0.00332298, 1.02206832 0.7 0.00441366, 1.02748038 0.7 0.00549608, 1.03285168 0.7 0.00657034, 1.0381828 0.7 0.00763656, 1.04347426 0.7 0.00869485, 1.04872659 0.7 0.00974532, 1.05394029 0.7 0.01078806, 1.05911583 0.7 0.01182317, 1.06425366 0.7 0.01285073, 1.06935421 0.7 0.01387084, 1.0744179 0.7 0.01488358, 1.07944512 0.7 0.01588902, 1.08443625 0.7 0.01688725, 1.08939165 0.7 0.01787833, 1.09431166 0.7 0.01886233, 1.09919663 0.7 0.01983933, 1.10404686 0.7 0.02080937, 1.10886266 0.7 0.02177253, 1.11364432 0.7 0.02272886, 1.11839213 0.7 0.02367843, 1.12310634 0.7 0.02462127, 1.12778722 0.7 0.02555744, 1.13243502 0.7 0.026487, 1.13704996 0.7 0.02740999, 1.14163228 0.7 0.02832646, 1.1461822 0.7 0.02923644, 1.15069992 0.7 0.03013998, 1.15518564 0.7 0.03103713, 1.15963956 0.7 0.03192791, 1.16406186 0.7 0.03281237, 1.16845271 0.7 0.03369054, 1.1728123 0.7 0.03456246, 1.17714077 0.7 0.03542815, 1.1814383 0.7 0.03628766, 1.18570502 0.7 0.037141, 1.18994108 0.7 0.03798822, 1.19414663 0.7 0.03882933, 1.19832179 0.7 0.03966436, 1.20246669 0.7 0.04049334, 1.20658145 0.7 0.04131629, 1.21066619 0.7 0.04213324, 1.21472103 0.7 0.04294421, 1.21874607 0.7 0.04374921, 1.22274141 0.7 0.04454828, 1.22670716 0.7 0.04534143, 1.2306434 0.7 0.04612868" />
	<circle z-index="0" layer="" cx="1.5" cy="1" cz="0" label="" r="4" stroke="black" stroke-width="2" fill="white" fill-opacity="1" stroke-opacity="1" animate="1.5 1 0, 1.50559759 0.99996835 -0.00055976, 1.51118409 0.99987365 -0.00111841, 1.51676007 0.99971621 -0.00167601, 1.52232604 0.99949631 -0.0022326, 1.52788247 0.99921418 -0.00278825, 1.5334298 0.99887 -0.00334298, 1.53896845 0.99846391 -0.00389685, 1.54449878 0.99799604 -0.00444988, 1.55002114 0.99746645 -0.00500211, 1.55553583 0.99687516 -0.00555358, 1.56104313 0.9962222 -0.00610431, 1.56654327 0.99550753 -0.00665433, 1.57203647 0.99473109 -0.00720365, 1.5775229 0.9938928 -0.00775229, 1.58300271 0.99299255 -0.00830027, 1.58847601 0.9920302 -0.0088476, 1.59394289 0.99100558 -0.00939429, 1.5994034 0.98991852 -0.00994034, 1.60485755 0.9887688 -0.01048576, 1.61030534 0.98755621 -0.01103053, 1.61574671 0.9862805 -0.01157467, 1.62118159 0.98494141 -0.01211816, 1.62660987 0.98353867 -0.01266099, 1.6320314 0.98207197 -0.01320314, 1.63744601 0.98054103 -0.0137446, 1.64285349 0.97894552 -0.01428535, 1.64825358 0.97728512 -0.01482536, 1.65364601 0.97555949 -0.0153646, 1.65903046 0.9737683 -0.01590305, 1.66440659 0.9719112 -0.01644066, 1.669774 0.96998783 -0.0169774, 1.67513227 0.96799784 -0.01751323, 1.68048094 0.96594087 -0.01804809, 1.68581951 0.96381658 -0.01858195, 1.69114744 0.96162461 -0.01911474, 1.69646417 0.95936461 -0.01964642, 1.70176908 0.95703625 -0.02017691, 1.70706151 0.95463918 -0.02070615, 1.71234079 0.95217309 -0.02123408, 1.71760617 0.94963766 -0.02176062, 1.7228569 0.94703261 -0.02228569, 1.72809215 0.94435764 -0.02280922, 1.73331109 0.94161249 -0.02333111, 1.73851282 0.93879693 -0.02385128, 1.74369642 0.93591074 -0.02436964, 1.74886092 0.93295372 -0.02488609, 1.75400531 0.92992571 -0.02540053, 1.75912854 0.92682657 -0.02591285, 1.76422954 0.92365621 -0.02642295" />
	<circle z-index="0" layer="" cx="1.5" cy="0.5" cz="0" label="" r="4" stroke="black" stroke-width="2" fill="white" fill-opacity="1" stroke-opacity="1"  />
	<pathC z-index="0" layer="" label="" stroke="black" stroke-width="1" stroke-opacity="1" fill="none" fill-opacity="1" d="0 1 2 3 4" />
</svg_doc>

<body style="margin:0px;background-color:;overflow:hidden;" >
	<a id='keydown' type='checkbox' onkeydown="javascript:;" ></a>
	<div style="font-family:Bookman Old Style;font-size:12px;margin:0px;background-color:;overflow:hidden;position:fixed;width:170px;top:20px;right:20px;" id='control_panel' >
		<div id='control_panel_layers' style="width:200px;" ></div>
	</div>
	<svg id="world" style="background-color:;width:100%;height:100%;position:absolute;top:0;left:0;z-index:-1;" onload="Javascript:onLoadFunctions();" xmlns="http://www.w3.org/2000/svg" version="1.1"></svg>
</body>

<script type="text/javascript" >
	var svgDocument = document.getElementById("world");
</script>

<script /svg_viewer_n.js" type="text/javascript" >

	// Parameters set by user
	var animation_duration = 1;
	var animation_reverse = 1;
	var animation_repeat = -1;
	var animation_count = 0;

	var animation_length = 0;
	var frame_width = 10;
	var object_name = 'shape_viewer_3d';
	var max_arrowhead_size = 15;
	
	view_box = new Array();
	window_properties = new Array();
	
	var eyez = 300;
	var zoom = 280;
	
	var anim_n = 0;
	var arrow_angle = 25;
	var currentEvent = "nothing";
	var depth;
	var globalkeypress = '';
	var IE = document.all ? true : false
	var initiate = 0;
	var maxzoom = -200;
	var margin = 40;
	var zoom_speed = 5;
	var sort_shapes = 1;
	var stop_anim = 0;
	var svgns = "http://www.w3.org/2000/svg";
	var tempX = 0;
	var tempY = 0;
	var mousedown = 0;
	var path_max_iter = 500; // Also max iteration for number of animation duration
	
	var point_color_r = 100;
	var point_color_g = 0;
	var point_color_b = 0;
	var point_opacity = 0.5;
	var point_radius = 4;
	
	var line_color_r = 0;
	var line_color_g = 0;
	var line_color_b = 0;
	var line_width = 1;
	var line_opacity = 1;
	
	var prevX, prevY;
	var ajax_output;
	
	test_array = new Array();
	
	zindex = new Array();
	Arrows = new Array();
	Images = new Array();
	Lines = new Array();
	LinesC = new Array();
	Paths = new Array();
	PathsC = new Array();
	Points = new Array();
	points_i_to_k = new Array();
	RefPoints = new Array();
	Shapes = new Array();
	Textlinks = new Array();
	
	AnimatePoints = new Array();
	AnimateArrows = new Array();
	AnimateLines = new Array();
	
	Translate = new Array();
	Rotate = new Array();
	
	function correctImagePosition(new_x,new_y,new_w,new_h,ow,oh){
	
		var x = new_x;
		var y = new_y;
		var w = new_w;
		var h = new_h;
	
		if(new_w < ow){w = ow;}
		if(new_h < oh){h = oh;}
		if(new_w < ow || new_h < oh){
			x = margin;
			y = margin;
			return {x : x, y : y, w : w, h : h};
		}
		if(new_x > margin){x = margin;}
		if(new_y > margin){y = margin;}
		if((new_x + new_w) < (margin + ow)){x = margin + ow - new_w;}
		if((new_y + new_h) < (margin + oh)){y = margin + oh - new_h;}
	
		return {x : x, y : y, w : w, h : h};
	}
	
	function detectKeyDown(e){
		var evt = e || window.event;
		if(evt.keyCode==82){globalkeypress = 'r';} // r
		if(evt.shiftKey === true){
			if(globalkeypress == 'r'){
				if(evt.keyCode==37){setKeyEvent("rotateYaxis", 45);} // left arrow
				if(evt.keyCode==39){setKeyEvent("rotateYaxis", -45);} // right arrow
				if(evt.keyCode==38){setKeyEvent("rotateXaxis", 45);} // up arrow
				if(evt.keyCode==40){setKeyEvent("rotateXaxis", -45);} // down arrow
				if(evt.keyCode==74){setKeyEvent("rotateZaxis", -45);} // j
				if(evt.keyCode==75){setKeyEvent("rotateZaxis", 45);} // k
			}else{
				if(evt.keyCode==37){setKeyEvent("translateX", -10);} // left arrow
				if(evt.keyCode==39){setKeyEvent("translateX", 10);} // right arrow
				if(evt.keyCode==38){setKeyEvent("translateY", 10);} // up arrow
				if(evt.keyCode==40){setKeyEvent("translateY", -10);} // down arrow
				if(evt.keyCode==74){setKeyEvent("translateZ", 10);} // j
				if(evt.keyCode==75){setKeyEvent("translateZ", -10);} // k
			}
		}else{
			if(evt.metaKey === true){
			}else{
				if(globalkeypress == 'r'){
					if(evt.keyCode==37){setKeyEvent("rotateYaxis", 10);} // left arrow
					if(evt.keyCode==39){setKeyEvent("rotateYaxis", -10);} // right arrow
					if(evt.keyCode==38){setKeyEvent("rotateXaxis", 10);} // up arrow
					if(evt.keyCode==40){setKeyEvent("rotateXaxis", -10);} // down arrow
					if(evt.keyCode==74){setKeyEvent("rotateZaxis", -10);} // j
					if(evt.keyCode==75){setKeyEvent("rotateZaxis", 10);} // k
				}else{
					if(evt.keyCode==37){setKeyEvent("translateX", -1);} // left arrow
					if(evt.keyCode==39){setKeyEvent("translateX", 1);} // right arrow
					if(evt.keyCode==38){setKeyEvent("translateY", 1);} // up arrow
					if(evt.keyCode==40){setKeyEvent("translateY", -1);} // down arrow
					if(evt.keyCode==74){setKeyEvent("translateZ", 1);} // j
					if(evt.keyCode==75){setKeyEvent("translateZ", -1);} // k
					//if(evt.keyCode==80){} // p
					if(evt.keyCode==32){setKeyEvent("playPauseAnimation");} // space-bar
				}
			}
		}
	}
	
	function doEvent(){
		if (currentEvent == "callZoomIn"){
			if(zoom <= 400){
				zoom = zoom + 4;
			}
		}
	
		if (currentEvent == "callZoomOut"){
			if(zoom >= 175){
				zoom = zoom - 4;
			}
		}
	
		if(currentEvent == "translateX"){
			translate(Arrows,d,0,0);
			translate(Lines,d,0,0);
			translate(Paths,d,0,0);
			translate(Points,d,0,0);
			translate(Textlinks,d,0,0);
			translate(RefPoints,d,0,0);
			translate(AnimatePoints,d,0,0);
			translate(AnimateArrows,d,0,0);
			translate(AnimateLines,d,0,0);
		}
		if(currentEvent == "translateY"){
			translate(Arrows,0,d,0);
			translate(Lines,0,d,0);
			translate(Paths,0,d,0);
			translate(Points,0,d,0);
			translate(Textlinks,0,d,0);
			translate(RefPoints,0,d,0);
			translate(AnimatePoints,0,d,0);
			translate(AnimateArrows,0,d,0);
			translate(AnimateLines,0,d,0);
		}
		if(currentEvent == "translateZ"){
			translate(Arrows,0,0,-d);
			translate(Lines,0,0,-d);
			translate(Paths,0,0,-d);
			translate(Points,0,0,-d);
			translate(Textlinks,0,0,-d);
			translate(RefPoints,0,0,-d);
			translate(AnimatePoints,0,0,-d);
			translate(AnimateArrows,0,0,-d);
			translate(AnimateLines,0,0,-d);
		}
	
		if (currentEvent == "rotateXaxis" || currentEvent == "rotateYaxis" || currentEvent == "rotateZaxis"){
			eval(currentEvent + '(Arrows, d)');
			eval(currentEvent + '(Lines, d)');
			eval(currentEvent + '(Paths, d)');
			eval(currentEvent + '(Points, d)');
			eval(currentEvent + '(Textlinks, d)');
			eval(currentEvent + '(RefPoints, d)');
			eval(currentEvent + '(AnimatePoints, d)');
			eval(currentEvent + '(AnimateArrows, d)');
			eval(currentEvent + '(AnimateLines, d)');
		}
	
		if (currentEvent == "playPauseAnimation"){
			if(stop_anim == 1){stop_anim = 0;}else{stop_anim = 1;}
			playPauseAnimation();
		}
	}
	
	function fitShapesToWindow(){
		var x = new Array();
		var y = new Array();
		var z = new Array();
	
		var i, j, k;
		k = 0;
		
		if(AnimatePoints.length > 0){
			for(i in AnimatePoints){
				for(j in AnimatePoints[i]){
					if(!is_numeric(j)) continue;
					if(isNaN(AnimatePoints[i][j][0])) continue;
					x[k] = AnimatePoints[i][j][0];
					y[k] = AnimatePoints[i][j][1];
					z[k] = AnimatePoints[i][j][2];
					k++;
				}
			}
		}
		if(AnimateArrows.length > 0){
			for(i in AnimateArrows){
				for(j in AnimateArrows[i]){
					if(!is_numeric(j)) continue;
					if(isNaN(AnimateArrows[i][j][0])) continue;
					x[k] = AnimateArrows[i][j][0];
					y[k] = AnimateArrows[i][j][1];
					z[k] = AnimateArrows[i][j][2];
					k++;
					x[k] = AnimateArrows[i][j][3];
					y[k] = AnimateArrows[i][j][4];
					z[k] = AnimateArrows[i][j][5];
					k++;
				}
			}
		}
		if(AnimateLines.length > 0){
			for(i in AnimateLines){
				for(j in AnimateLines[i]){
					if(!is_numeric(j)) continue;
					if(isNaN(AnimateLines[i][j][0])) continue;
					x[k] = AnimateLines[i][j][0];
					y[k] = AnimateLines[i][j][1];
					z[k] = AnimateLines[i][j][2];
					k++;
					x[k] = AnimateLines[i][j][3];
					y[k] = AnimateLines[i][j][4];
					z[k] = AnimateLines[i][j][5];
					k++;
				}
			}
		}
		for(i in Arrows){
			if(isNaN(Arrows[i][0][0])) continue;
			x[k] = Arrows[i][0][0];
			y[k] = Arrows[i][0][1];
			z[k] = Arrows[i][0][2];
			k++;
			x[k] = Arrows[i][1][0];
			y[k] = Arrows[i][1][1];
			z[k] = Arrows[i][1][2];
			k++;
		}
		for(i in Points){
			if(isNaN(Points[i][0])) continue;
			x[k] = Points[i][0];
			y[k] = Points[i][1];
			z[k] = Points[i][2];
			k++;
		}
		for(i in Paths){
			var j = 0;
			while(j < Paths[i].length){
				if(!Paths[i][j]){break;}
				if(Paths[i][j][0] == 'Z'){break;}
				if(isNaN(Paths[i][j][1])) continue;
				x[k] = Paths[i][j][1];
				y[k] = Paths[i][j][2];
				z[k] = Paths[i][j][3];
				j++;
				k++;
			}
		}
		for(i in Lines){
			if(isNaN(Lines[i][0][0])) continue;
			x[k] = Lines[i][0][0];
			y[k] = Lines[i][0][1];
			z[k] = Lines[i][0][2];
			k++;
			x[k] = Lines[i][1][0];
			y[k] = Lines[i][1][1];
			z[k] = Lines[i][1][2];
			k++;
		}
		for(i in Textlinks){
			if(Textlinks[i].text_size){var text_length = Textlinks[i].text_size*Textlinks[i].text.length*0.6;}else{var text_length = 0;}
			if(isNaN(Textlinks[i][0])) continue;
			x[k] = Textlinks[i][0];// + text_length;
			y[k] = Textlinks[i][1];
			z[k] = Textlinks[i][2];
			k++;
		}
	
		x.sort(sortasc);
		y.sort(sortasc);
		z.sort(sortasc);
	
		x_range = (x[x.length-1] - x[0]);
		y_range = (y[y.length-1] - y[0]);
		z_range = (z[z.length-1] - z[0]);
		if(isNaN(x_range) || isNaN(y_range) || isNaN(z_range)) return;
	
		depth = Math.floor(zoom * (eyez - maxzoom) / 100 + eyez);
		var mm_to_pixel = (-(depth - eyez) / - eyez);
	
		var object = document.getElementById(object_name);
		var view_width = getWindowWidth() - 2*margin;
		var view_height = getWindowHeight() - 2*margin;
	
		var rw = (x_range*mm_to_pixel)/view_width;
		var rh = (y_range*mm_to_pixel)/view_height;
		var rd = (z_range*mm_to_pixel)/view_height;
	
		if(x_range*mm_to_pixel > view_width){
			if(rw > rh){
				if(rd > rw){var factor = 1/rd*2;}else{var factor = 1/rw;}
			}else{
				if(rd > rh){var factor = 1/rd*2;}else{var factor = 1/rh;}		
			}
		}else{
			if(rw > rh){
				if(rd > rw){var factor = 1/rd;}else{var factor = 1/rw;}
			}else{
				if(rd > rh){var factor = 1/rd;}else{var factor = 1/rh;}		
			}
		}
	
		translate(Arrows, -(x[0] + x_range/2), -(y[0] + y_range/2), -(z[0] + z_range/2));
		translate(Lines, -(x[0] + x_range/2), -(y[0] + y_range/2), -(z[0] + z_range/2));
		translate(Paths, -(x[0] + x_range/2), -(y[0] + y_range/2), -(z[0] + z_range/2));
		translate(Points, -(x[0] + x_range/2), -(y[0] + y_range/2), -(z[0] + z_range/2));
		translate(Textlinks, -(x[0] + x_range/2), -(y[0] + y_range/2), -(z[0] + z_range/2));
	
		scale(Arrows, factor);
		scale(Lines, factor);
		scale(Paths, factor);
		scale(Points, factor);
		scale(Textlinks, factor);
		scale(RefPoints, factor);
	
		if(animation_length > 1){
			translate(AnimatePoints, -(x[0] + x_range/2), -(y[0] + y_range/2), -(z[0] + z_range/2));
			translate(AnimateArrows, -(x[0] + x_range/2), -(y[0] + y_range/2), -(z[0] + z_range/2));
			translate(AnimateLines, -(x[0] + x_range/2), -(y[0] + y_range/2), -(z[0] + z_range/2));
			scale(AnimatePoints, factor);
			scale(AnimateArrows, factor);
			scale(AnimateLines, factor);
		}
	}
	
	function getMouseMoveXY(e){
		svgDocument.onmousedown = function(){
			initialX = e.clientX;
			initialY = e.clientY;
			mousedown = 1;
		}
			
		if(initiate == 0){
			prevX = initialX;
			prevY = initialY;
		}
		initiate = 1;
	
		if(IE){
			tempX = e.clientX + document.body.scrollLeft;
			tempY = e.clientY + document.body.scrollTop;
		}else{
			tempX = e.pageX;
			tempY = e.pageY;
		}  
	
		if (tempX < 0){tempX = 0;}
		if (tempY < 0){tempY = 0;}  
		if(mousedown == 1 && globalkeypress == ''){
			distX = tempX - prevX;
			distY = prevY - tempY;
			
			if(distX !== 0){setKeyEvent("translateX",Math.round(distX/4.667));}  // manually calibrated
			if(distY !== 0){setKeyEvent("translateY",Math.round(distY/4.667));}
		}
		if(mousedown == 1 && globalkeypress == 'r'){
			distX = tempX - prevX;
			distY = prevY - tempY;
			
			if(distX !== 0){setKeyEvent("rotateYaxis",Math.round(-distX));}
			if(distY !== 0){setKeyEvent("rotateXaxis",Math.round(distY));}
		}
	
		svgDocument.onmouseup = function(){mousedown = 0;}
	
		prevX = tempX
		prevY = tempY
	
		return false;
	}
	
	function get_transformations(){
	
		if(document.getElementsByTagName("transformation").length){
			for(i = 0;i < document.getElementsByTagName("transformation").length;i++){
	
				var svg_elem = document.getElementsByTagName("transformation")[i];
	
				// SET TRANSLATE ARRAY
				if(svg_elem.getAttribute("translate") !== null) Translate = Translate.concat(string_to_array_cs(svg_elem.getAttribute("translate")))
	
				// SET ROTATE ARRAY
				if(svg_elem.getAttribute("rotate") !== null) Rotate = Rotate.concat(string_to_array_cs(svg_elem.getAttribute("rotate")))
			}
		}
	}
	
	function get_shapes(){
	
		var i, j, k, m;
		var t_arr, n_str, c_str;
	
		if(document.getElementsByTagName("pathC").length){
			for(i = 0;i < document.getElementsByTagName("pathC").length;i++){
	
				var svg_elem = document.getElementsByTagName("pathC")[i];
	
				// SET ID AND ATTRIBUTES
				PathsC[i] = new Array();
				PathsC[i].id = "PathsC" + (PathsC.length - 1);
	
				if(svg_elem.getAttribute("fill") == null){PathsC[i].fill = "none";}else{PathsC[i].fill = svg_elem.getAttribute("fill");}
				if(svg_elem.getAttribute("fill-opacity") == null){PathsC[i].fill_opacity = 1;}else{PathsC[i].fill_opacity = parseFloat(svg_elem.getAttribute("fill-opacity"));}
				if(svg_elem.getAttribute("stroke") == null){PathsC[i].stroke = "black";}else{PathsC[i].stroke = svg_elem.getAttribute("stroke");}
				if(svg_elem.getAttribute("stroke-width") == null){PathsC[i].stroke_width = 1;}else{PathsC[i].stroke_width = parseFloat(svg_elem.getAttribute("stroke-width"));}
				if(svg_elem.getAttribute("stroke-opacity") == null){PathsC[i].stroke_opacity = 1;}else{PathsC[i].stroke_opacity = parseFloat(svg_elem.getAttribute("stroke-opacity"));}
				if(svg_elem.getAttribute("z-index") == null){PathsC[i].z_index = 0;}else{PathsC[i].z_index = parseFloat(svg_elem.getAttribute("z-index"));}
				if(svg_elem.getAttribute("layer") == null || svg_elem.getAttribute("layer") == ""){PathsC[i].layer = "Default";}else{PathsC[i].layer = svg_elem.getAttribute("layer");}
				if(svg_elem.getAttribute("layer-group") == null || svg_elem.getAttribute("layer-group") == ""){PathsC[i].layer_group = "Default";}else{PathsC[i].layer_group = svg_elem.getAttribute("layer-group");}
	
				PathsC[i].d = svg_elem.getAttribute("d");
				PathsC[i][0] = PathsC[i].d.split(" ");
			}
		}
	
		if(document.getElementsByTagName("path").length){
			for(i = 0;i < document.getElementsByTagName("path").length;i++){
	
				var svg_elem = document.getElementsByTagName("path")[i];
	
				// SET ID AND ATTRIBUTES
				Paths[i] = new Array();
	
				// CREATE ARRAY STRUCTURE FROM PATH
				Paths[i] = svg_path_string_to_array(svg_elem.getAttribute("d"));
	
				Paths[i].id = "Paths" + (Paths.length - 1);
	
				if(svg_elem.getAttribute("fill") == null){Paths[i].fill = "none";}else{Paths[i].fill = svg_elem.getAttribute("fill");}
				if(svg_elem.getAttribute("fill-opacity") == null){Paths[i].fill_opacity = 1;}else{Paths[i].fill_opacity = parseFloat(svg_elem.getAttribute("fill-opacity"));}
				if(svg_elem.getAttribute("stroke") == null){Paths[i].stroke = "black";}else{Paths[i].stroke = svg_elem.getAttribute("stroke");}
				if(svg_elem.getAttribute("stroke-width") == null){Paths[i].stroke_width = 1;}else{Paths[i].stroke_width = parseFloat(svg_elem.getAttribute("stroke-width"));}
				if(svg_elem.getAttribute("stroke-opacity") == null){Paths[i].stroke_opacity = 1;}else{Paths[i].stroke_opacity = parseFloat(svg_elem.getAttribute("stroke-opacity"));}
				if(svg_elem.getAttribute("z-index") == null){Paths[i].z_index = 0;}else{Paths[i].z_index = parseFloat(svg_elem.getAttribute("z-index"));}
				if(svg_elem.getAttribute("layer") == null || svg_elem.getAttribute("layer") == ""){Paths[i].layer = "Default";}else{Paths[i].layer = svg_elem.getAttribute("layer");}
				if(svg_elem.getAttribute("layer-group") == null || svg_elem.getAttribute("layer-group") == ""){Paths[i].layer_group = "Default";}else{Paths[i].layer_group = svg_elem.getAttribute("layer-group");}
			}
		}
	
		if(document.getElementsByTagName("pathC").length){
			for(i = 0;i < document.getElementsByTagName("pathC").length;i++){
	
				var svg_elem = document.getElementsByTagName("pathC")[i];
	
				// SET ID AND ATTRIBUTES
				PathsC[i] = new Array();
				PathsC[i].id = "PathsC" + (PathsC.length - 1);
	
				if(svg_elem.getAttribute("fill") == null){PathsC[i].fill = "none";}else{PathsC[i].fill = svg_elem.getAttribute("fill");}
				if(svg_elem.getAttribute("fill-opacity") == null){PathsC[i].fill_opacity = 1;}else{PathsC[i].fill_opacity = parseFloat(svg_elem.getAttribute("fill-opacity"));}
				if(svg_elem.getAttribute("stroke") == null){PathsC[i].stroke = "black";}else{PathsC[i].stroke = svg_elem.getAttribute("stroke");}
				if(svg_elem.getAttribute("stroke-width") == null){PathsC[i].stroke_width = 1;}else{PathsC[i].stroke_width = parseFloat(svg_elem.getAttribute("stroke-width"));}
				if(svg_elem.getAttribute("stroke-opacity") == null){PathsC[i].stroke_opacity = 1;}else{PathsC[i].stroke_opacity = parseFloat(svg_elem.getAttribute("stroke-opacity"));}
				if(svg_elem.getAttribute("z-index") == null){PathsC[i].z_index = 0;}else{PathsC[i].z_index = parseFloat(svg_elem.getAttribute("z-index"));}
				if(svg_elem.getAttribute("layer") == null || svg_elem.getAttribute("layer") == ""){PathsC[i].layer = "Default";}else{PathsC[i].layer = svg_elem.getAttribute("layer");}
				if(svg_elem.getAttribute("layer-group") == null || svg_elem.getAttribute("layer-group") == ""){PathsC[i].layer_group = "Default";}else{PathsC[i].layer_group = svg_elem.getAttribute("layer-group");}
	
				PathsC[i].d = svg_elem.getAttribute("d");
				PathsC[i][0] = PathsC[i].d.split(" ");
			}
		}
	
		if(document.getElementsByTagName("line").length){
			for(i = 0;i < document.getElementsByTagName("line").length;i++){
	
				var svg_elem = document.getElementsByTagName("line")[i];
	
				// SET ID AND ATTRIBUTES
				Lines[i] = new Array();
				Lines[i].id = "Lines" + (Lines.length - 1);
				Lines[i][0] = new Array(parseFloat(svg_elem.getAttribute("x1")), parseFloat(svg_elem.getAttribute("y1")), parseFloat(svg_elem.getAttribute("z1")));
				Lines[i][1] = new Array(parseFloat(svg_elem.getAttribute("x2")), parseFloat(svg_elem.getAttribute("y2")), parseFloat(svg_elem.getAttribute("z2")));
	
				if(svg_elem.getAttribute("stroke") == null){Lines[i].stroke = "black";}else{Lines[i].stroke = svg_elem.getAttribute("stroke");}
				if(svg_elem.getAttribute("stroke-width") == null){Lines[i].stroke_width = 1;}else{Lines[i].stroke_width = parseFloat(svg_elem.getAttribute("stroke-width"));}
				if(svg_elem.getAttribute("opacity") == null){Lines[i].opacity = 1;}else{Lines[i].opacity = parseFloat(svg_elem.getAttribute("opacity"));}
				if(svg_elem.getAttribute("z-index") == null){Lines[i].z_index = 0;}else{Lines[i].z_index = parseFloat(svg_elem.getAttribute("z-index"));}
				if(svg_elem.getAttribute("layer") == null || svg_elem.getAttribute("layer") == ""){Lines[i].layer = "Default";}else{Lines[i].layer = svg_elem.getAttribute("layer");}
				if(svg_elem.getAttribute("layer-group") == null || svg_elem.getAttribute("layer-group") == ""){Lines[i].layer_group = "Default";}else{Lines[i].layer_group = svg_elem.getAttribute("layer-group");}
				if(svg_elem.getAttribute("animate") !== null){
					j = AnimateLines.length;
					AnimateLines[j] = string_to_array_cs(svg_elem.getAttribute("animate"));
					AnimateLines[j].idx = i;
				}
			}
		}
	
		if(document.getElementsByTagName("arrow").length){
			for(i = 0;i < document.getElementsByTagName("arrow").length;i++){
	
				var svg_elem = document.getElementsByTagName("arrow")[i];
	
				// SET ID AND ATTRIBUTES
				Arrows[i] = new Array();
				Arrows[i].id = "Arrows" + (Arrows.length - 1);
				Arrows[i][0] = new Array(parseFloat(svg_elem.getAttribute("x1")), parseFloat(svg_elem.getAttribute("y1")), parseFloat(svg_elem.getAttribute("z1")));
				Arrows[i][1] = new Array(parseFloat(svg_elem.getAttribute("x2")), parseFloat(svg_elem.getAttribute("y2")), parseFloat(svg_elem.getAttribute("z2")));
	
				if(svg_elem.getAttribute("s") == null){Arrows[i].s = 1;}else{Arrows[i].s = parseFloat(svg_elem.getAttribute("s"));}
				if(svg_elem.getAttribute("stroke") == null){Arrows[i].stroke = "black";}else{Arrows[i].stroke = svg_elem.getAttribute("stroke");}
				if(svg_elem.getAttribute("stroke-width") == null){Arrows[i].stroke_width = 1;}else{Arrows[i].stroke_width = parseFloat(svg_elem.getAttribute("stroke-width"));}
				if(svg_elem.getAttribute("stroke-opacity") == null){Arrows[i].stroke_opacity = 1;}else{Arrows[i].stroke_opacity = parseFloat(svg_elem.getAttribute("stroke-opacity"));}
				if(svg_elem.getAttribute("vis") == null){Arrows[i].vis = 1;}else{Arrows[i].vis = svg_elem.getAttribute("vis");}
				if(svg_elem.getAttribute("z-index") == null){Arrows[i].z_index = 0;}else{Arrows[i].z_index = parseFloat(svg_elem.getAttribute("z-index"));}
				if(svg_elem.getAttribute("layer") == null || svg_elem.getAttribute("layer") == ""){Arrows[i].layer = "Default";}else{Arrows[i].layer = svg_elem.getAttribute("layer");}
				if(svg_elem.getAttribute("layer-group") == null || svg_elem.getAttribute("layer-group") == ""){Arrows[i].layer_group = "Default";}else{Arrows[i].layer_group = svg_elem.getAttribute("layer-group");}
				if(svg_elem.getAttribute("animate") !== null){
					j = AnimateArrows.length;
					AnimateArrows[j] = string_to_array_cs(svg_elem.getAttribute("animate"));
					AnimateArrows[j].idx = i;
				}
			}
		}
	
		if(document.getElementsByTagName("text").length){
			for(i = 0;i < document.getElementsByTagName("text").length;i++){
	
				var svg_elem = document.getElementsByTagName("text")[i];
	
				// SET ID AND ATTRIBUTES
				Textlinks[i] = new Array(parseFloat(svg_elem.getAttribute("x")), parseFloat(svg_elem.getAttribute("y")), parseFloat(svg_elem.getAttribute("z")));
				Textlinks[i].id = "Textlinks" + (Textlinks.length - 1);
				Textlinks[i].text = svg_elem.childNodes[0].nodeValue;
				//Textlinks[i][0] = new Array(parseFloat(svg_elem.getAttribute("x")), parseFloat(svg_elem.getAttribute("y")), parseFloat(svg_elem.getAttribute("z")));
	
				if(svg_elem.getAttribute("text-anchor") == null){Textlinks[i].text_anchor = "middle";}else{Textlinks[i].text_anchor = svg_elem.getAttribute("text-anchor");}
				if(svg_elem.getAttribute("text-size") !== null){Textlinks[i].text_size = parseFloat(svg_elem.getAttribute("text-size"));}
				if(svg_elem.getAttribute("font-size") !== null){Textlinks[i].font_size = parseFloat(svg_elem.getAttribute("font-size"));}
				if(svg_elem.getAttribute("text-size") == null && svg_elem.getAttribute("font-size") == null){Textlinks[i].font_size = 12;}
				if(svg_elem.getAttribute("fill") == null){Textlinks[i].fill = "black";}else{Textlinks[i].fill = svg_elem.getAttribute("fill");}
				if(svg_elem.getAttribute("opacity") == null){Textlinks[i].opacity = 1;}else{Textlinks[i].opacity = parseFloat(svg_elem.getAttribute("opacity"));}
				if(svg_elem.getAttribute("font-family") == null){Textlinks[i].font_name = "Franklin Gothic Book";}else{Textlinks[i].font_name = svg_elem.getAttribute("font-family");}
				if(svg_elem.getAttribute("font-style") == null){Textlinks[i].font_style = "";}else{Textlinks[i].font_style = svg_elem.getAttribute("font-style");}
				if(svg_elem.getAttribute("font-weight") == null){Textlinks[i].font_weight = "";}else{Textlinks[i].font_weight = svg_elem.getAttribute("font-weight");}
				if(svg_elem.getAttribute("letter-spacing") == null){Textlinks[i].letter_spacing = 0;}else{Textlinks[i].letter_spacing = parseFloat(svg_elem.getAttribute("letter-spacing"));}
				if(svg_elem.getAttribute("z-index") == null){Textlinks[i].z_index = 0;}else{Textlinks[i].z_index = parseFloat(svg_elem.getAttribute("z-index"));}
				if(svg_elem.getAttribute("layer") == null || svg_elem.getAttribute("layer") == ""){Textlinks[i].layer = "Default";}else{Textlinks[i].layer = svg_elem.getAttribute("layer");}
				if(svg_elem.getAttribute("layer-group") == null || svg_elem.getAttribute("layer-group") == ""){Textlinks[i].layer_group = "Default";}else{Textlinks[i].layer_group = svg_elem.getAttribute("layer-group");}
				if(svg_elem.getAttribute("vertical") == null || svg_elem.getAttribute("vertical") == "" || svg_elem.getAttribute("vertical") == 0){Textlinks[i].vertical = 0;}else{Textlinks[i].vertical = 1;}
			}
		}
	
		if(document.getElementsByTagName("circle").length){
			for(i = 0;i < document.getElementsByTagName("circle").length;i++){
	
				var svg_elem = document.getElementsByTagName("circle")[i];
	
				// SET ID AND ATTRIBUTES
				Points[i] = new Array(parseFloat(svg_elem.getAttribute("cx")), parseFloat(svg_elem.getAttribute("cy")), parseFloat(svg_elem.getAttribute("cz")));
				Points[i].id = "Points" + (Points.length - 1);
	
				if(svg_elem.getAttribute("r") == null){Points[i].radius = 1;}else{Points[i].radius = parseFloat(svg_elem.getAttribute("r"));}
				if(svg_elem.getAttribute("fill") == null){Points[i].fill = "black";}else{Points[i].fill = svg_elem.getAttribute("fill");}
				if(svg_elem.getAttribute("stroke") == null){Points[i].stroke = "black";}else{Points[i].stroke = svg_elem.getAttribute("stroke");}
				if(svg_elem.getAttribute("stroke-width") == null){Points[i].stroke_width = 1;}else{Points[i].stroke_width = parseFloat(svg_elem.getAttribute("stroke-width"));}
				if(svg_elem.getAttribute("stroke-opacity") == null){Points[i].stroke_opacity = 1;}else{Points[i].stroke_opacity = parseFloat(svg_elem.getAttribute("stroke-opacity"));}
				if(svg_elem.getAttribute("fill-opacity") == null){Points[i].fill_opacity = 1;}else{Points[i].fill_opacity = parseFloat(svg_elem.getAttribute("fill-opacity"));}
				if(svg_elem.getAttribute("z-index") == null){Points[i].z_index = 0;}else{Points[i].z_index = parseFloat(svg_elem.getAttribute("z-index"));}
				if(svg_elem.getAttribute("layer") == null || svg_elem.getAttribute("layer") == ""){Points[i].layer = "Default";}else{Points[i].layer = svg_elem.getAttribute("layer");}
				if(svg_elem.getAttribute("layer-group") == null || svg_elem.getAttribute("layer-group") == ""){Points[i].layer_group = "Default";}else{Points[i].layer_group = svg_elem.getAttribute("layer-group");}
				if(svg_elem.getAttribute("animate") !== null){
					j = AnimatePoints.length;
					AnimatePoints[j] = string_to_array_cs(svg_elem.getAttribute("animate"));
					AnimatePoints[j].idx = i;
				}
			}
		}
	
		// SET REFERENCE POINTS
		RefPoints[0] = new Array(0,0,0)
	}
	
	function getWindowSizeProjection(z){
	
		if(z == null) var z = RefPoints[0][2];
	
		var x_window_shift = getWindowWidth()/2;
		var y_window_shift = getWindowHeight()/2;
	
		var depth = Math.floor(zoom * (eyez - maxzoom) / 100 + eyez);
	
		var min_x = -(z - eyez)*(-x_window_shift)/(depth - eyez) - RefPoints[0][0]
		var max_x = -(z - eyez)*(x_window_shift)/(depth - eyez) - RefPoints[0][0]
	
		var min_y = -(z - eyez)*(-y_window_shift)/(depth - eyez) - RefPoints[0][1]
		var max_y = -(z - eyez)*(y_window_shift)/(depth - eyez) - RefPoints[0][1]
	
		//alert(min_x + ', ' + max_x + ', ' + min_y + ', ' + max_y);
	
		return {min_x : min_x, max_x : max_x, min_y : min_y, max_y : max_y, range_x : max_x-min_x, range_y : max_y-min_y};
	}
	
	function pixel_to_font_size(pixel_height){
		return pixel_height*1.43;
	}
	
	function rotateXaxis(a, d){
		var t = rotateTrig(degToRad(d));
		var tmp;
		var i, j, k;
		
		for(i in a){
			if(is_array(a[i][0])){
				var j = 0;
				while(j < path_max_iter){
					if(!a[i][j]){break;}
					if(a[i][j][0] === "A"){continue;}
					if(is_numeric(a[i][j][0])){
						for(k = 0;k < a[i][j].length;k = k + 3){
							tmp = (t.sin * a[i][j][k+1]) + (t.cos * a[i][j][k+2]);
							a[i][j][k+1] = (t.cos * a[i][j][k+1]) - (t.sin * a[i][j][k+2]);
							a[i][j][k+2] = tmp;
						}
					}else{
						tmp = (t.sin * a[i][j][2]) + (t.cos * a[i][j][3]);
						a[i][j][2] = (t.cos * a[i][j][2]) - (t.sin * a[i][j][3]);
						a[i][j][3] = tmp;
					}
					j++;
				}
			}else{
				tmp = (t.sin * a[i][1]) + (t.cos * a[i][2]);
				a[i][1] = (t.cos * a[i][1]) - (t.sin * a[i][2]);
				a[i][2] = tmp;
			}
		}
	}
	
	function rotateYaxis(a, d){
		var t = rotateTrig(degToRad(d));
		var tmp;
		var i, j, k;
	
		for(i in a){
			if(is_array(a[i][0])){
				var j = 0;
				while(j < path_max_iter){
					if(!a[i][j]){break;}
					if(a[i][j][0] === "A"){continue;}
					if(is_numeric(a[i][j][0])){
						for(k = 0;k < a[i][j].length;k = k + 3){
							tmp = - (t.sin * a[i][j][k+0]) + (t.cos * a[i][j][k+2])
							a[i][j][k+0] = (t.cos * a[i][j][k+0])  + (t.sin * a[i][j][k+2]);
							a[i][j][k+2] = tmp;
						}
					}else{
						tmp = - (t.sin * a[i][j][1]) + (t.cos * a[i][j][3])
						a[i][j][1] = (t.cos * a[i][j][1])  + (t.sin * a[i][j][3]);
						a[i][j][3] = tmp;
					}
					j++;
				}
			}else{
				tmp = - (t.sin * a[i][0]) + (t.cos * a[i][2])
				a[i][0] = (t.cos * a[i][0])  + (t.sin * a[i][2]);
				a[i][2] = tmp;
			}
		}
	}
	
	
	function rotateZaxis(a, d){
		var t = rotateTrig(degToRad(d));
		var tmp;
		var i, j, k;
	
		for(i in a){
			if(is_array(a[i][0])){
				var j = 0;
				while(j < path_max_iter){
					if(!a[i][j]){break;}
					if(a[i][j][0] === "A"){continue;}
					if(is_numeric(a[i][j][0])){
						for(k = 0;k < a[i][j].length;k = k + 3){
							tmp = (t.sin * a[i][j][k+0]) + (t.cos * a[i][j][k+1])
							a[i][j][k+0] = (t.cos * a[i][j][k+0]) - (t.sin * a[i][j][k+1]);
							a[i][j][k+1] = tmp;
						}
					}else{
						tmp = (t.sin * a[i][j][1]) + (t.cos * a[i][j][2])
						a[i][j][1] = (t.cos * a[i][j][1]) - (t.sin * a[i][j][2]);
						a[i][j][2] = tmp;
					}
					j++;
				}
			}else{
				tmp = (t.sin * a[i][0]) + (t.cos * a[i][1])
				a[i][0] = (t.cos * a[i][0]) - (t.sin * a[i][1]);
				a[i][1] = tmp;
			}
		}
	}
	
	
	function scale(a,factor){
		var i, j, k;
		for(i = 0;i < a.length;i++){		
			if(a[i].s) a[i].s = a[i].s*factor;
			if(a[i].text_size) a[i].text_size = a[i].text_size*factor;
			if(is_array(a[i][0])){
				var j = 0;
				while(j < path_max_iter){
					if(!a[i][j]){break;}
					if(a[i][j][0] === "A"){continue;}
					if(is_numeric(a[i][j][0])){
						for(k = 0;k < a[i][j].length;k = k + 3){ // For AnimateArrows
							a[i][j][k+0] = a[i][j][k+0]*factor;
							a[i][j][k+1] = a[i][j][k+1]*factor;
							a[i][j][k+2] = a[i][j][k+2]*factor;
						}
					}else{
						a[i][j][1] = a[i][j][1]*factor;
						a[i][j][2] = a[i][j][2]*factor;
						a[i][j][3] = a[i][j][3]*factor;
					}
					j++;
				}
			}else{
				a[i][0] = a[i][0]*factor;
				a[i][1] = a[i][1]*factor;
				a[i][2] = a[i][2]*factor;
			}
		}
		return a;
	}
	
	function scrollEvent(e){
		var id = baseName(e);
		var delta = 0;
	
		if(IE){
			s_initialX = event.clientX + document.body.scrollLeft;
			s_initialY = event.clientY + document.body.scrollTop;
			if(!event){event = window.event;}
	    	var delta = event.wheelDelta / 40;
		}else{
			s_initialX = e.pageX;
			s_initialY = e.pageY;
		}
	
		if(e.detail){
			var delta = -e.detail*5;
			var max = 8;
			if(delta > max){delta = max;}
			if(delta < -max){delta = -max;}
			zoom_shape(Math.round(delta*0.2)/20,s_initialX,s_initialY);
		}
	
		if(e.wheelDelta){ // SAFARI
			var delta = e.wheelDelta;
			var max = 60;
			if(delta > max){delta = max;}
			if(delta < -max){delta = -max;}
			zoom_shape(Math.round(delta*0.1)/20,s_initialX,s_initialY);
		}
	}
	
	function setKeyEvent(eventin,dist){
		currentEvent = eventin;
		d = dist;
	
		if (eventin !== "nothing" && eventin !== "refreshtozero"){
			doEvent();
			updateShapes();
		}
	}
	
	function translate(a,u,v,w){
		var i, j, k;
		for(i = 0;i < a.length;i++){
			if(is_array(a[i][0])){
				var j = 0;
				while(j < path_max_iter){
					if(!a[i][j]){break;}
					if(a[i][j][0] === "A"){continue;}
					//if(is_numeric(j) == false){j++;continue;}
					if(is_numeric(a[i][j][0])){
						if(a[i][j].length == 3){
							a[i][j][0] = a[i][j][0] + u;
							a[i][j][1] = a[i][j][1] + v;
							a[i][j][2] = a[i][j][2] + w;
						}else{
							a[i][j][0] = a[i][j][0] + u;
							a[i][j][1] = a[i][j][1] + v;
							a[i][j][2] = a[i][j][2] + w;
							a[i][j][3] = a[i][j][3] + u;
							a[i][j][4] = a[i][j][4] + v;
							a[i][j][5] = a[i][j][5] + w;
						}
	//					for(k = 0;k < a[i][j].length;k = k + 3){ // For AnimateArrows
	//						a[i][j][k+0] = a[i][j][k+0] + u;
	//						a[i][j][k+1] = a[i][j][k+1] + v;
	//						a[i][j][k+2] = a[i][j][k+2] + w;
	//					}
					}else{
						a[i][j][1] = a[i][j][1] + u;
						a[i][j][2] = a[i][j][2] + v;
						a[i][j][3] = a[i][j][3] + w;
					}
					j++;
				}
			}else{
				a[i][0] = a[i][0] + u;
				a[i][1] = a[i][1] + v;
				a[i][2] = a[i][2] + w;
			}
		}
		return a;
	}
	
	function updateShapes(){
	
		var i, j, k, n_i0, n_i1, pathd, u, u1, u2, len;
		var circle, line, n_i, type, visibility, vec;
	
		depth = Math.floor(zoom * (eyez - maxzoom) / 100 + eyez);
		wsize_proj = getWindowSizeProjection();
	
		k = 0;
		for(i in Arrows){
			u1 = -(depth - eyez) / (Arrows[i][0][2] - eyez);
			u2 = -(depth - eyez) / (Arrows[i][1][2] - eyez);
		
			Shapes[k].x1 = (u1 * Arrows[i][0][0]) + x_window_shift;
			Shapes[k].y1 = -(u1 * Arrows[i][0][1]) + y_window_shift;
			Shapes[k].x2 = (u2 * Arrows[i][1][0]) + x_window_shift;
			Shapes[k].y2 = -(u2 * Arrows[i][1][1]) + y_window_shift;
			Shapes[k].len = dist(new Array(Shapes[k].x1, Shapes[k].y1), new Array(Shapes[k].x2, Shapes[k].y2))
	
			if(5*Arrows[i].s > max_arrowhead_size){Shapes[k].f = max_arrowhead_size;}else{Shapes[k].f = 5*Arrows[i].s;}
			k++;
		}
	
		for(i in Lines){
			u1 = -(depth - eyez) / (Lines[i][0][2] - eyez);
			u2 = -(depth - eyez) / (Lines[i][1][2] - eyez);
		
			Shapes[k].x1 = (u1 * Lines[i][0][0]) + x_window_shift;
			Shapes[k].y1 = -(u1 * Lines[i][0][1]) + y_window_shift;
			Shapes[k].x2 = (u2 * Lines[i][1][0]) + x_window_shift;
			Shapes[k].y2 = -(u2 * Lines[i][1][1]) + y_window_shift;
			k++;
		}
	
		for(i in Points){
			u = -(depth - eyez) / (Points[i][2] - eyez);
	
			Shapes[k].cx = (u * Points[i][0]) + x_window_shift;
			Shapes[k].cy = -(u * Points[i][1]) + y_window_shift;
			//Shapes[k].zindex = k;
			k++;
		}
	
		for(i in Paths){
			pathd = '';
			j = 0;
			while(j < Paths[i].length){
				if(!Paths[i][j]){break;}
				type = Paths[i][j][0];
				if(type == 'Z'){
					pathd += type;
				}else{
					u = -(depth - eyez) / (Paths[i][j][3] - eyez);
					pathd += type + " " + ((u * Paths[i][j][1]) + x_window_shift) + " " + (-(u * Paths[i][j][2]) + y_window_shift) + " ";
				}
				j++;
			}
			Shapes[k].vis = 1;
			Shapes[k].path = pathd;
			k++;
		}
	
		for(i in PathsC){
			pathd = '';
			j = 0;
			while(j < PathsC[i][0].length){
				if(PathsC[i][0][j] !== 0 && !PathsC[i][0][j]) break;
	
				n_i = points_i_to_k[PathsC[i][0][j]];
				if(j == 0){type = "M";}else{type = "L";}
				pathd += type + Shapes[n_i].cx + " " + Shapes[n_i].cy + " ";
				j++;
			}
			Shapes[k].path = pathd;
			k++;
		}
	
		for(i in LinesC){
			n_i0 = points_i_to_k[LinesC[i][0]];
			n_i1 = points_i_to_k[LinesC[i][1]];
		
			Shapes[k].x1 = Shapes[n_i0].cx;
			Shapes[k].y1 = Shapes[n_i0].cy;
			Shapes[k].x2 = Shapes[n_i1].cx;
			Shapes[k].y2 = Shapes[n_i1].cy;
			k++;
		}
	
		for(i in Textlinks){
	
			u = -(depth - eyez) / (Textlinks[i][2] - eyez);
	
			Shapes[k].vis = 1;
			Shapes[k].x = (u * Textlinks[i][0]);
			Shapes[k].y = -(u * Textlinks[i][1]);
			if(Textlinks[i].text_size){
				Shapes[k].font_size = pixel_to_font_size(Textlinks[i].text_size);
			}else{
				Shapes[k].font_size = Textlinks[i].font_size;
			}
			if(Textlinks[i].vertical){Shapes[k].vertical = 1}else{Shapes[k].vertical = 0;}
	
			//Shapes[k].zindex = k;
			k++;
		}
	
		if(sort_shapes) zindex.sort(function(a,b){return a.z - b.z})
	
		for(j in zindex){
			i = zindex[j].i;
	
			if(layer_groups[Shapes[i].layer_group].visibility == 0 || layer_groups[Shapes[i].layer_group][Shapes[i].layer].visibility == 0){visibility = "hidden";}else{visibility = "";}
			if(Shapes[i].type == "arrow"){
				line = svgDocument.getElementById(Shapes[i].id);
				if(sort_shapes) svgDocument.removeChild(line);
				line.setAttribute("x1", Shapes[i].x1);
				line.setAttribute("y1", Shapes[i].y1);
				line.setAttribute("x2", Shapes[i].x2);
				line.setAttribute("y2", Shapes[i].y2);
				line.setAttribute("visibility", visibility);
				if(sort_shapes) svgDocument.appendChild(line);
				
				vec = new Array(Shapes[i].x1 - Shapes[i].x2, Shapes[i].y1 - Shapes[i].y2);
	
				vec = uvector(vec);
				v1 = rotateVector(vec, arrow_angle);
				v2 = rotateVector(vec, -arrow_angle);
				arrowhead = svgDocument.getElementById(Shapes[i].id + "arrowhead");
				if(sort_shapes) svgDocument.removeChild(arrowhead);
				arrowhead.setAttribute("d", "M" + (Shapes[i].x2 + v1[0]*Shapes[i].f) + " " + (Shapes[i].y2 + v1[1]*Shapes[i].f) + " L" + (Shapes[i].x2) + " " + (Shapes[i].y2)  + " L" + (Shapes[i].x2 + v2[0]*Shapes[i].f) + " " + (Shapes[i].y2 + v2[1]*Shapes[i].f));
				arrowhead.setAttribute("visibility", visibility);
				if(sort_shapes) svgDocument.appendChild(arrowhead);
			}
			if(Shapes[i].type == "Paths" || Shapes[i].type == "PathsC"){
				path = svgDocument.getElementById(Shapes[i].id);
				if(sort_shapes) svgDocument.removeChild(path);
				path.setAttribute("d", Shapes[i].path);
				path.setAttribute("visibility", visibility);
				if(sort_shapes) svgDocument.appendChild(path);
			}
			if(Shapes[i].type == "point"){
				circle = svgDocument.getElementById(Shapes[i].id);
				if(sort_shapes) svgDocument.removeChild(circle);
				circle.setAttribute("cx", Shapes[i].cx);
				circle.setAttribute("cy", Shapes[i].cy);
				circle.setAttribute("visibility", visibility);
				if(sort_shapes) svgDocument.appendChild(circle);
			}
			if(Shapes[i].type == "lineC"){
				line = svgDocument.getElementById(Shapes[i].id);
				if(sort_shapes) svgDocument.removeChild(line);
				line.setAttribute("x1", Shapes[i].x1);
				line.setAttribute("y1", Shapes[i].y1);
				line.setAttribute("x2", Shapes[i].x2);
				line.setAttribute("y2", Shapes[i].y2);
				line.setAttribute("visibility", visibility);
				if(sort_shapes) svgDocument.appendChild(line);
			}
			if(Shapes[i].type == "line"){
				line = svgDocument.getElementById(Shapes[i].id);
				if(sort_shapes) svgDocument.removeChild(line);
				line.setAttribute("x1", Shapes[i].x1);
				line.setAttribute("y1", Shapes[i].y1);
				line.setAttribute("x2", Shapes[i].x2);
				line.setAttribute("y2", Shapes[i].y2);
				line.setAttribute("visibility", visibility);
				if(sort_shapes) svgDocument.appendChild(line);
			}
			if(Shapes[i].type == "textlink"){
				textlink = svgDocument.getElementById(Shapes[i].id);
				if(sort_shapes) svgDocument.removeChild(textlink);
				textlink.setAttribute("font-size", Math.ceil(Shapes[i].font_size));
				textlink.setAttribute("visibility", visibility);
				textlink.setAttribute("x", Shapes[i].x + x_window_shift);
				textlink.setAttribute("y", Shapes[i].y + y_window_shift);
				if(Shapes[i].vertical){
					//alert(Shapes[i].x + x_window_shift + ', ' + (-Shapes[i].y + y_window_shift));
					textlink.setAttribute("transform", 'rotate(-90, ' + (Shapes[i].x + x_window_shift) + ', ' + (Shapes[i].y + y_window_shift) + ')');
					//textlink.setAttribute("x", 0);
					//textlink.setAttribute("y", 0);
					//textlink.setAttribute("transform", 'rotate(10, ' + 600 + ', ' + 600 + ')');
				}
				if(sort_shapes) svgDocument.appendChild(textlink);
			}
		}
	}
	
	function zoom_shape(d, mouseX, mouseY){
		if(d == 0){return;}
	
		var zoom_speed_n = zoom_speed;
		if(BrowserDetect.browser == "Firefox") var zoom_speed_n = zoom_speed*0.5;
	
		var d = d/zoom_speed_n;
	
		scale(Arrows, 1 + d);
		scale(Lines, 1 + d);
		scale(Paths, 1 + d);
		scale(Points, 1 + d);
		scale(Textlinks, 1 + d);
		scale(RefPoints, 1 + d);
	
		if(AnimatePoints.length > 0 || AnimateArrows.length > 0 || AnimateLines.length > 0){
			scale(AnimateArrows, 1 + d);
			scale(AnimatePoints, 1 + d);
			scale(AnimateLines, 1 + d);
		}
	
		updateShapes();
	}
</script>
<script /svg_viewer_n.js" type="text/javascript" >
	var background_color;
	
	function addReverseAnimationStates(a){
		var i, j, k;
	
		for(i in a){
			for(j = a[i].length - 1;j >= 0;j--){
				var new_j = a[i].length;
				a[i][new_j] = new Array();
				for(k = 0;k < a[i][j].length;k++){
					a[i][new_j][k] = a[i][j][k];
				}
			}
		}
		return a;
	}
	
	function animateShapes(){
		var i, j, k;
	
		if(animation_repeat > -1 && animation_count > animation_repeat) return
	
		var anim_n_i = anim_n;
		
		if(AnimatePoints.length > 0 && anim_n == AnimatePoints[0].length) anim_n = 0
		if(AnimateArrows.length > 0 && anim_n == AnimateArrows[0].length) anim_n = 0
		if(AnimateLines.length > 0 && anim_n == AnimateLines[0].length) anim_n = 0
		
		if(anim_n < anim_n_i) animation_count++
		if(animation_repeat > -1 && animation_count > animation_repeat) return
	
		for(i = 0; i < AnimatePoints.length; i++){
			for(j = 0; j < AnimatePoints[i][anim_n].length; j++) Points[AnimatePoints[i].idx][j] = AnimatePoints[i][anim_n][j]			
		}
	
		for(i = 0; i < AnimateArrows.length; i++){
			k = 0;
			for(j = 0; j < AnimateArrows[i][anim_n].length / 2; j++, k++) Arrows[AnimateArrows[i].idx][0][j] = AnimateArrows[i][anim_n][k]			
			for(j = 0; j < AnimateArrows[i][anim_n].length / 2; j++, k++) Arrows[AnimateArrows[i].idx][1][j] = AnimateArrows[i][anim_n][k]
		}
	
		for(i = 0; i < AnimateLines.length; i++){
			k = 0;
			for(j = 0; j < AnimateLines[i][anim_n].length / 2; j++, k++) Lines[AnimateLines[i].idx][0][j] = AnimateLines[i][anim_n][k]
			for(j = 0; j < AnimateLines[i][anim_n].length / 2; j++, k++) Lines[AnimateLines[i].idx][1][j] = AnimateLines[i][anim_n][k]
		}
		
		animation_length_wreverse = animation_length
		if(animation_reverse) animation_length_wreverse = animation_length*2
	
		if(Translate.length > 0){
			if((animation_count*animation_length_wreverse + anim_n) < Translate.length){
				currentEvent = "translateX";
				d = Translate[anim_n][0];
				doEvent();
		
				currentEvent = "translateY";
				d = Translate[anim_n][1];
				doEvent();
		
				currentEvent = "translateZ";
				d = Translate[anim_n][2];
				doEvent();
			}
		}
	
		if(Rotate.length > 0){
			if((animation_count*animation_length_wreverse + anim_n) < Rotate.length){
				currentEvent = "rotateXaxis";
				d = Rotate[anim_n][0];
				doEvent();
		
				currentEvent = "rotateYaxis";
				d = Rotate[anim_n][1];
				doEvent();
		
				currentEvent = "rotateZaxis";
				d = Rotate[anim_n][2];
				doEvent();
			}
		}
	
		anim_n++;
		updateShapes();
	}
	
	function baseName(ev) {
		var id = ev.target.getAttribute("id");
		return id;
	}
	
	function degToRad(d){
		return d*(Math.PI/180);
	}
	
	function detectKeyUp(e){
		var evt = e || window.event;
		if(evt.keyCode==82 && globalkeypress == "r"){globalkeypress = '';return;}
	}
	
	function dist(a, b){
		var i;
		var s = 0;
		for(i = 0;i < a.length;i++) s += Math.pow(b[i] - a[i], 2)
		return Math.sqrt(s);
	}
	
	function getMouseXYLocal(e){
		if(IE){return new Array(event.clientX,event.clientY);}else{return new Array(e.pageX,e.pageY);}
	}
	
	function playPauseAnimation(){
		if(stop_anim == 1){clearInterval(intervalID);}else{startAnimation();}
	}
	
	function loadBackground(){
	
		if(document.getElementsByTagName("background").length){
			for(i = 0;i < document.getElementsByTagName("background").length;i++){
	
				var svg_elem = document.getElementsByTagName("background")[i];
				background_color  = svg_elem.getAttribute("color");
	
				var rect = document.createElementNS(svgns, "rect");
	
				rect.setAttribute("width", window_properties.width*4);
				rect.setAttribute("height", window_properties.height*4);
				rect.setAttribute("x", 0);
				rect.setAttribute("y", 0);
				rect.setAttribute("fill", background_color);
				svgDocument.appendChild(rect);
			}
		}else{
			background_color = "white";
		}
	}
	
	function onLoadFunctions(evt){
	
		svgns = "http://www.w3.org/2000/svg";
		XLINK = "http://www.w3.org/1999/xlink";
	
		svgDocument = document.getElementById("world");
	
		window.onresize = function(event) {
			onWindowResize();
			updateShapes();
		}
	
		if(BrowserDetect.browser == "Firefox"){
			svgDocument.style.width = getWindowWidth() + "px";
			svgDocument.style.height = getWindowHeight() + "px";
		}
	
		document.getElementById('keydown').focus();
		document.getElementById('keydown').onclick = setEvents;
		document.getElementById('keydown').onclick();
		document.onkeyup = detectKeyUp;
		svgDocument.onmousemove = getMouseMoveXY;
		svgDocument.onkeyup = detectKeyUp;
		svgDocument.onkeydown = detectKeyDown;
		if(window.addEventListener){svgDocument.addEventListener('DOMMouseScroll', scrollEvent, false);}
		svgDocument.onmousewheel = scrollEvent;
	
		setViewboxProperties();
		get_shapes();
		get_transformations();
	
		if(AnimatePoints[0]) animation_length = AnimatePoints[0].length;	
		if(AnimateArrows[0]) animation_length = AnimateArrows[0].length;	
		if(AnimateLines[0]) animation_length = AnimateLines[0].length;	
	
		loadBackground();
		preloadShapes();
	
		if(Images.length == 0){
			set_interzoom_interval = 0;
			zoom_scroll_strength = 0.1;
		}
	
		fitShapesToWindow();
		updateShapes();
	
		if(animation_length > 1){
			if(animation_reverse){AnimatePoints = addReverseAnimationStates(AnimatePoints);}
			if(animation_reverse){AnimateArrows = addReverseAnimationStates(AnimateArrows);}
			if(animation_reverse){AnimateLines = addReverseAnimationStates(AnimateLines);}
			startAnimation();
		}
	}
	
	function onWindowResize(){
	
		if(BrowserDetect.browser == "Firefox"){
			svgDocument.style.width = getWindowWidth() + "px";
			svgDocument.style.height = getWindowHeight() + "px";
		}
	
		setViewboxProperties();
		fitShapesToWindow();
	}
	
	function preloadShapes(){ 	 	
		//w = getWindowWidth();
		//h = getWindowHeight();
	
		//resizeObjectsToWindow(w*scale,h*scale);
		var i, j;
		var k = 0;
		for(i in Arrows){
			Shapes[k] = new Array();
			Shapes[k].id = Arrows[i].id;
			Shapes[k].type = "arrow";
			Shapes[k].layer_name = Arrows[i].layer;
			Shapes[k].layer_group_name = Arrows[i].layer_group;
	
			zindex[k] = new Array();
			zindex[k].z = Arrows[i].z_index;
			zindex[k].i = k;
	
			var line = document.createElementNS(svgns, "line");
			line.setAttribute("id", Arrows[i].id);
			line.setAttribute("style", "stroke:" + Arrows[i].stroke + ";stroke-width:" + Arrows[i].stroke_width + ";opacity:" + Arrows[i].stroke_opacity + ";");
			svgDocument.appendChild(line);
	
			arrowhead = document.createElementNS(svgns, "path");
			arrowhead.setAttribute("id", Arrows[i].id + "arrowhead");
			arrowhead.setAttribute("style", "stroke:" + Arrows[i].stroke + ";stroke-width:" + Arrows[i].stroke_width + ";opacity:" + Arrows[i].stroke_opacity + ";fill:none;");
			svgDocument.appendChild(arrowhead);
			k++;
		}
	
		for(i in Lines){
			Shapes[k] = new Array();
			Shapes[k].id = Lines[i].id;
			Shapes[k].type = "line";
			Shapes[k].layer_name = Lines[i].layer;
			Shapes[k].layer_group_name = Lines[i].layer_group;
	
			zindex[k] = new Array();
			zindex[k].z = Lines[i].z_index;
			zindex[k].i = k;
	
			var line = document.createElementNS(svgns, "line");
			line.setAttribute("id", Lines[i].id);
			line.setAttribute("style", "stroke:" + Lines[i].stroke + ";stroke-width:" + Lines[i].stroke_width + ";opacity:" + Lines[i].opacity + ";");
			svgDocument.appendChild(line);
			k++;
		}
	
		for(i in Points){
			Shapes[k] = new Array();
			Shapes[k].id = Points[i].id;
			Shapes[k].type = "point";
			Shapes[k].layer_name = Points[i].layer;
			Shapes[k].layer_group_name = Points[i].layer_group;
			points_i_to_k[i] = k;
	
			zindex[k] = new Array();
			zindex[k].z = Points[i].z_index;
			zindex[k].i = k;
	
			circle = document.createElementNS(svgns, "circle");
			circle.setAttribute("id", Points[i].id);
			circle.setAttribute("r", Points[i].radius);
			circle.setAttribute("fill", Points[i].fill);
			circle.setAttribute("style", "stroke:" + Points[i].stroke + ";stroke-width:" + Points[i].stroke_width + ";fill-opacity:" + Points[i].fill_opacity + ";stroke-opacity:" + Points[i].stroke_opacity + ";");
			svgDocument.appendChild(circle);
			k++;
		}
	
		for(i in Paths){
			Shapes[k] = new Array();
			Shapes[k].id = Paths[i].id;
			Shapes[k].type = "Paths";
			Shapes[k].layer_name = Paths[i].layer;
			Shapes[k].layer_group_name = Paths[i].layer_group;
	
			zindex[k] = new Array();
			zindex[k].z = Paths[i].z_index;
			zindex[k].i = k;
	
			path = document.createElementNS(svgns, "path");
			path.setAttribute("id", Paths[i].id);
			path.setAttribute("style", "fill:" + Paths[i].fill + ";fill-opacity:" + Paths[i].fill_opacity + ";stroke:" + Paths[i].stroke + ";stroke-width:" + Paths[i].stroke_width + ";stroke-opacity:" + Paths[i].stroke_opacity + ";");
			svgDocument.appendChild(path);
			k++;
		}
	
		for(i in PathsC){
			Shapes[k] = new Array();
			Shapes[k].id = PathsC[i].id;
			Shapes[k].type = "PathsC";
			Shapes[k].layer_name = PathsC[i].layer;
			Shapes[k].layer_group_name = PathsC[i].layer_group;
	
			zindex[k] = new Array();
			zindex[k].z = PathsC[i].z_index;
			zindex[k].i = k;
			//PathsC[i].stroke_width = 4;
	
			path = document.createElementNS(svgns, "path");
			path.setAttribute("id", PathsC[i].id);
			path.setAttribute("style", "fill:" + PathsC[i].fill + ";fill-opacity:" + PathsC[i].fill_opacity + ";stroke:" + PathsC[i].stroke + ";stroke-width:" + PathsC[i].stroke_width + ";stroke-opacity:" + PathsC[i].stroke_opacity + ";");
			svgDocument.appendChild(path);
			k++;
		}
	
		for(i in Textlinks){
			Shapes[k] = new Array();
			Shapes[k].id = Textlinks[i].id;
			Shapes[k].type = "textlink";
			Shapes[k].vz_min = Textlinks[i].vz_min;
			Shapes[k].vz_max = Textlinks[i].vz_max;
			Shapes[k].layer_name = Textlinks[i].layer;
			Shapes[k].layer_group_name = Textlinks[i].layer_group;
	
			zindex[k] = new Array();
			zindex[k].z = Textlinks[i].z_index;
			zindex[k].i = k;
	
			if(!Textlinks[i].font_size){Textlinks[i].font_size = 12;}
	
			textBlock = document.createTextNode(Textlinks[i].text);
			var textlink = document.createElementNS(svgns, "text");
			textlink.setAttribute("id", Textlinks[i].id);
			textlink.setAttribute("text-anchor", Textlinks[i].text_anchor);
			textlink.setAttribute("font-size", Textlinks[i].font_size);
			textlink.setAttribute("font-weight", Textlinks[i].font_weight);
			textlink.setAttribute("fill", Textlinks[i].fill);
			textlink.setAttribute("opacity", Textlinks[i].opacity);
			//alert(Textlinks[i].id + " " + Textlinks[i].text_anchor + " " + Textlinks[i].font_size + " " + Textlinks[i].fill + " " + Textlinks[i].opacity);
			
			if(Textlinks[i].italic){var font_style = "italic";}else{var font_style = "";}
			if(Textlinks[i].bold){var font_weight = "bold";}else{var font_weight = "";}
			textlink.setAttribute("style", "font-family:" + Textlinks[i].font_name + ";letter-spacing:0;font-style:" + font_style + ";font-weight:" + font_weight + ";");
			//textlink.setAttribute("writing-mode", "rl-tb");
			
			//alert(Textlinks[i].font_name);
			//textlink.addEventListener("mousemove", function(evt) { evt.preventDefault(); }, false);
			//textlink.addEventListener("mouseover", function(evt) { evt.preventDefault(); }, false);
			
			textlink.appendChild(textBlock);
			svgDocument.appendChild(textlink);
	
			k++;
		}
	
		for(i in LinesC){
			Shapes[k] = new Array();
			Shapes[k].id = LinesC[i].id;
			Shapes[k].type = "lineC";
			Shapes[k].layer_name = LinesC[i].layer;
			Shapes[k].layer_group_name = LinesC[i].layer_group;
	
			zindex[k] = new Array();
			zindex[k].z = LinesC[i].z_index;
			zindex[k].i = k;
	
			line = document.createElementNS(svgns, "line");
			line.setAttribute("id", LinesC[i].id);
			line.setAttribute("style", "stroke:" + "rgb(" + line_color_r + "," + line_color_g + "," + line_color_b + ")" + ";stroke-width:" + LinesC[i].stroke_width
			+ ";stroke-opacity:" + LinesC[i].stroke_opacity + ";");
			svgDocument.appendChild(line);
			k++;
		}
	
		for(i in Images){
			Shapes[k] = new Array();
			Shapes[k].id = Images[i].id;
			Shapes[k].type = "image";
			Shapes[k].layer_name = Images[i].layer;
			Shapes[k].layer_group_name = Images[i].layer_group;
	
			zindex[k] = new Array();
			zindex[k].z = Images[i].z_index;
			zindex[k].i = k;
	
			var image = document.createElementNS(svgns, "image");
			image.setAttribute("id", Images[i].id);
			image.setAttributeNS(XLINK,"href", Images[i].href);
			image.setAttribute("style", "opacity:" + Images[i].opacity + ";");
			svgDocument.appendChild(image);
			k++;
		}
	
		layer_groups_unique = array_unique_properties(Shapes, "layer_group_name");
		layers_unique = array_unique_properties(Shapes, "layer_name");
	
		// CREATE ARRAY TO SAVE LAYER GROUP VISIBILITY
		layer_groups = new Array();
		for(i in layer_groups_unique){
			layer_groups[i] = new Array();
			layer_groups[i].visibility = 1;
			layer_groups[i].name = layer_groups_unique[i];
		
			var layers_by_group = new Array();
			for(j in Shapes){
				if(Shapes[j].layer_group_name !== layer_groups_unique[i]) continue;
				layers_by_group[layers_by_group.length] = Shapes[j].layer_name;
			}
			layers_by_group_unique = array_unique(layers_by_group);
	
			for(j in layers_by_group_unique){
				layer_groups[i][j] = new Array();
				layer_groups[i][j].visibility = 1;
				layer_groups[i][j].name = layers_by_group_unique[j];
			}
		}
	
		// MATCH LAYER NAMES WITH NUMBER INDEX IN LAYERS_UNIQUE
		for(i in Shapes){
			for(j in layer_groups){
				if(Shapes[i].layer_group_name !== layer_groups[j].name) continue
				Shapes[i].layer_group = j;
	
				for(k in layer_groups[j]){
					if(Shapes[i].layer_name !== layer_groups[j][k].name) continue
					Shapes[i].layer = k;
					break;
				}
				break;
			}
		}
		
		write_layer_control_panel(layer_groups);
	
	//	Shapes.sort(function(a,b){return b.zindex - a.zindex})
	}
	
	function rotateTrig(r){return {sin : -Math.sin(r), cos : Math.cos(r)};}
	
	function rotateVector(v, deg){
		var rad = degToRad(deg);
		var vec = new Array(v[0]*Math.cos(rad) - v[1]*Math.sin(rad), v[0]*Math.sin(rad) + v[1]*Math.cos(rad));
		return vec;
	}
	
	function setEvents(e) {
		var eventHandler = detectKeyDown;
		document['on'+this.id] = eventHandler;
	}
	
	function setViewboxProperties(){
		window_properties.height = getWindowHeight();
		window_properties.width = getWindowWidth();
	
		view_box.height = window_properties.height;
		view_box.width = window_properties.width;
	
		x_window_shift = view_box.width/2;
		y_window_shift = view_box.height/2;
	}
	
	function startAnimation(){
		if(animation_reverse){var animation_duration_n = animation_duration/2;}else{var animation_duration_n = animation_duration;}
		var animation_interval = (animation_duration_n*1000) / animation_length;
		intervalID = setInterval(animateShapes, Math.round(animation_interval));
	}
	
	function string_to_array_cs(string){
	
		var i, j;
		var t_arr = string.split(",");
	
		r_arr = new Array();
		for(i = 0;i < t_arr.length;i++){
			i_arr = trim(t_arr[i]).split(" ");
			
			r_arr[i] = new Array();
			for(j = 0;j < i_arr.length;j++) r_arr[i][j] = parseFloat(i_arr[j])
		}
	
		return r_arr;
	}
	
	function svg_path_string_to_array(string){
	
		var i, j, a;
		var s = "";
		
		// SPLIT PATH BY LETTERS, NUMBERS, SPACES OR COMMAS
		// TO ADD!!: Z AT THE END OF THE PATH
		m_arr = new Array();
		for(i=0;i < string.length;i++){
			a = string.substring(i, i+1);
	
			if(is_numeric(a) == is_numeric(s)) s += a
			if(a == " " || a == ","){
				m_arr[m_arr.length] = trim(s.toUpperCase());
				s = "";
			}
			if(is_numeric(a) !== is_numeric(s)){
				if(s.length) m_arr[m_arr.length] = trim(s.toUpperCase())
				s = a;
			}
		}
		m_arr[m_arr.length] = trim(s.toUpperCase());
	
		r_arr = new Array();
		if(is_numeric(m_arr[3])){
			for(j = 0, k = 0;j < m_arr.length;j = j + 4, k++){
				r_arr[k] = new Array();
				r_arr[k][0] = m_arr[j];
				r_arr[k][1] = parseFloat(m_arr[j+1]);
				r_arr[k][2] = parseFloat(m_arr[j+2]);
				r_arr[k][3] = parseFloat(m_arr[j+3]);
			}
		}else{
			if(m_arr[3] == "Q"){
	
				r_arr[0] = new Array();
				r_arr[0][0] = m_arr[0];
				r_arr[0][1] = parseFloat(m_arr[1]);
				r_arr[0][2] = parseFloat(m_arr[2]);
				for(j = 4, k = 1;j < m_arr.length;j = j + 2, k++){
					r_arr[k] = new Array();
					r_arr[k][0] = "";
					r_arr[k][1] = parseFloat(m_arr[j]);
					r_arr[k][2] = parseFloat(m_arr[j+1]);
				}
				r_arr[1][0] = "Q";
				if(!is_numeric(m_arr[m_arr.length-1])) r_arr[r_arr.length-1][0] = m_arr[m_arr.length-1]			
			}else{
				for(j = 0, k = 0;j < m_arr.length;j = j + 3, k++){
					r_arr[k] = new Array();
					r_arr[k][0] = m_arr[j];
					r_arr[k][1] = parseFloat(m_arr[j+1]);
					r_arr[k][2] = parseFloat(m_arr[j+2]);
				}
			}
		}
	
		return r_arr;
	}
	
	function uvector(v){
		var i, r;
		var s = 0;
		for(i = 0;i < v.length;i++) s += Math.pow(v[i], 2)
		var d = Math.sqrt(s);
		if(d == 0) return v;
	
		r = new Array();
		for(i = 0;i < v.length;i++) r[i] = v[i]/d
		return r;
	}
	
	function write_layer_control_panel(layer_groups){
	
		//if(layer_groups.length == 1 && layer_groups[0].name == "Default") return;
		var i, j;
		var k = 0;
	
		var div_control_panel_layers = document.getElementById("control_panel_layers");
		if(layer_groups != "") div_control_panel_layers.innerHTML += "Layers";
	
		style_arr = parse_style_string(div_control_panel_layers.getAttribute("style"));
		div_width = extract_number(style_arr.width);
	
		for(i in layer_groups){
			var div_layer_group = document.createElement("div");
			if(layer_groups.length > 1 && layer_groups[0].name !== "Default"){
				var table = document.createElement("table");
				table.setAttribute("style", "margin:0 0 0 5px;border-collapse: collapse;");
				var tr = document.createElement("tr");
		
				var td = document.createElement("td");
				td.innerHTML = "<input type=\"checkbox\" name=\"" + j + "\" onClick=\"javascript:if(layer_groups["+i+"].visibility){layer_groups["+i+"].visibility = 0;}else{layer_groups["+i+"].visibility = 1;};updateShapes();\" checked />";
				tr.appendChild(td);
		
				var td = document.createElement("td");
				td.setAttribute("style", "font-weight:bold;");
				td.innerHTML = layer_groups[i].name;
				tr.appendChild(td);
		
				table.appendChild(tr);
				div_control_panel_layers.appendChild(table);
		
				div_layer_group.setAttribute("style", "margin:0 0 0 15px;");
				k++;
			}
	
			if(layer_groups[i].length == 1 && layer_groups[i][0].name == "Default") continue;
	
			var table = document.createElement("table");
			for(j = 0;j < layer_groups[i].length;j++){
				var tr = document.createElement("tr");
		
				var td = document.createElement("td");
				td.innerHTML = "<input type=\"checkbox\" name=\"" + j + "\" onClick=\"javascript:if(layer_groups["+i+"]["+j+"].visibility){layer_groups["+i+"]["+j+"].visibility = 0;}else{layer_groups["+i+"]["+j+"].visibility = 1;};updateShapes();\" checked />";
				td.setAttribute("style", "line-height:5px;height:5px;");
				tr.appendChild(td);
		
				var td = document.createElement("td");
				td.innerHTML = layer_groups[i][j].name;
				td.setAttribute("style", "line-height:5px;height:5px;");
				tr.appendChild(td);
		
				table.appendChild(tr);
				k++;
			}
	
			div_layer_group.appendChild(table);
			if(k < 12){
				var overflow_style = "";
			}else{
				var overflow_style = "overflow-y:scroll;";
			}
			if(background_color == "black"){
				div_control_panel_layers.setAttribute("style", "height:300px;color:white;" + overflow_style);
			}else{
				div_control_panel_layers.setAttribute("style", "height:300px;" + overflow_style);
			}
			div_control_panel_layers.appendChild(div_layer_group);
		}
	}
</script>
<script /svg_viewer_n.js" type="text/javascript" >
	
	function_name = new Array();
	url_path = new Array();
	innerHTML_id = new Array();
	request_status = new Array();
	xmlHttp = new Array();
	time1 = new Array();
	time2 = new Array();
	var req_ct = 0;
	var skip_buffer = 10;
	var skip_to = 0;
	var ajax_output;
	var auto_view_r_result = 0;
	
	function ajax_alert_return(j, xmlHttp_object){
		alert(xmlHttp_object[j].responseText);
	}
	
	function ajax_fill_element(j, xmlHttp_object){
		document.getElementById(innerHTML_id[j]).innerHTML = xmlHttp_object[j].responseText;
		window.status= '';
	}
	
	function ajax_fill_element_return_call(j, xmlHttp_object){
		document.getElementById(innerHTML_id[j]).innerHTML = xmlHttp_object[j].responseText;
		on_ajax_request_return();
	}
	
	function ajax_fill_element_return_call2(j, xmlHttp_object){
		document.getElementById(innerHTML_id[j]).innerHTML = xmlHttp_object[j].responseText;
		on_ajax_request_return2(url_path[j]);
	}
	
	function ajax_get_xml_http_object(){
		var xmlHttp=null;
		try{ // Firefox, Opera 8.0+, Safari
			xmlHttp = new XMLHttpRequest();}
		catch(e){ // Internet Explorer		
			try{
				xmlHttp = new ActiveXObject("Msxml2.XMLHTTP");}
			catch(e){
				xmlHttp = new ActiveXObject("Microsoft.XMLHTTP");}
		}
		return xmlHttp;
	}
	
	function ajax_request(url, send_content, call_function, element_id){
		url_path[req_ct] = url;
		function_name[req_ct] = call_function;
		innerHTML_id[req_ct] = element_id;
		request_status[req_ct] = 0;
	
		xmlHttp[req_ct]=ajax_get_xml_http_object();
		if(xmlHttp[req_ct]==null){
			alert ("Browser does not support HTTP Request");
			return;}
		xmlHttp[req_ct].onreadystatechange=ajax_state_changed;
		xmlHttp[req_ct].open("POST", url, true);
		xmlHttp[req_ct].setRequestHeader("Content-type","application/x-www-form-urlencoded");
		xmlHttp[req_ct].send(send_content);	
		window.status= 'Command to ' + url + ' sent.';
	
		time1[req_ct] = new Date().getTime() / 1000;
	
		req_ct++;
	}
	
	function ajax_state_changed(){
		var j;
		for(j = skip_to;j < xmlHttp.length; j++){
			if(request_status[j] == 1){continue;}
			if(xmlHttp[j].readyState==4 || xmlHttp[j].readyState=="complete"){
				//alert(skip_to + ' -- ' + j);
				eval(function_name[j] + '(j, xmlHttp)');
	
				time2[j] = new Date().getTime() / 1000;
				if(document.getElementById("run_time")) document.getElementById("run_time").innerHTML = "Run-time: " + Math.round((time2[j] - time1[j])*100)/100 + " sec";
				
				request_status[j] = 1;
				if(j - skip_buffer > 0){skip_to = j - skip_buffer;}
			}	
		}
	}
	
	function array_unique(arr) {
		var hash = {}, result = [];
		for(var i = 0, l = arr.length;i < l;++i){
	    	if(hash[ arr[i] ] === true) continue;
			hash[ arr[i] ] = true;
			result.push(arr[i]);    	
	    }
	    return result;
	}
	
	function array_unique_properties(arr, property) {
		var hash = {}, result = [];
		for(var i = 0, l = arr.length;i < l;++i){
	    	if(hash[ arr[i][property] ] === true) continue;
			hash[ arr[i][property] ] = true;
			result.push(arr[i][property]);    	
	    }
	    return result;
	}
	
	var BrowserDetect = {
		//Source: http://www.quirksmode.org/js/detect.html
	
		init: function () {
			this.browser = this.searchString(this.dataBrowser) || "An unknown browser";
			this.version = this.searchVersion(navigator.userAgent)
				|| this.searchVersion(navigator.appVersion)
				|| "an unknown version";
			this.OS = this.searchString(this.dataOS) || "an unknown OS";
		},
		searchString: function (data) {
			for (var i=0;i<data.length;i++)	{
				var dataString = data[i].string;
				var dataProp = data[i].prop;
				this.versionSearchString = data[i].versionSearch || data[i].identity;
				if (dataString) {
					if (dataString.indexOf(data[i].subString) != -1)
						return data[i].identity;
				}
				else if (dataProp)
					return data[i].identity;
			}
		},
		searchVersion: function (dataString) {
			var index = dataString.indexOf(this.versionSearchString);
			if (index == -1) return;
			return parseFloat(dataString.substring(index+this.versionSearchString.length+1));
		},
		dataBrowser: [
			{
				string: navigator.userAgent,
				subString: "Chrome",
				identity: "Chrome"
			},
			{ 	string: navigator.userAgent,
				subString: "OmniWeb",
				versionSearch: "OmniWeb/",
				identity: "OmniWeb"
			},
			{
				string: navigator.vendor,
				subString: "Apple",
				identity: "Safari",
				versionSearch: "Version"
			},
			{
				prop: window.opera,
				identity: "Opera",
				versionSearch: "Version"
			},
			{
				string: navigator.vendor,
				subString: "iCab",
				identity: "iCab"
			},
			{
				string: navigator.vendor,
				subString: "KDE",
				identity: "Konqueror"
			},
			{
				string: navigator.userAgent,
				subString: "Firefox",
				identity: "Firefox"
			},
			{
				string: navigator.vendor,
				subString: "Camino",
				identity: "Camino"
			},
			{		// for newer Netscapes (6+)
				string: navigator.userAgent,
				subString: "Netscape",
				identity: "Netscape"
			},
			{
				string: navigator.userAgent,
				subString: "MSIE",
				identity: "Explorer",
				versionSearch: "MSIE"
			},
			{
				string: navigator.userAgent,
				subString: "Gecko",
				identity: "Mozilla",
				versionSearch: "rv"
			},
			{ 		// for older Netscapes (4-)
				string: navigator.userAgent,
				subString: "Mozilla",
				identity: "Netscape",
				versionSearch: "Mozilla"
			}
		],
		dataOS : [
			{
				string: navigator.platform,
				subString: "Win",
				identity: "Windows"
			},
			{
				string: navigator.platform,
				subString: "Mac",
				identity: "Mac"
			},
			{
				   string: navigator.userAgent,
				   subString: "iPhone",
				   identity: "iPhone/iPod"
		    },
			{
				string: navigator.platform,
				subString: "Linux",
				identity: "Linux"
			}
		]
	
	};
	
	BrowserDetect.init();
	
	function clean(array, deleteValue){
		for(var i = 0; i < array.length; i++) {
			if(array[i] == deleteValue){
				array.splice(i, 1);
				i--;
				continue;
			}
			if(isNaN(deleteValue) && isNaN(array[i])){
				array.splice(i, 1);
				i--;
				continue;
			}
		}
		return array;
	}
	
	function createCookie(name, value, sec){
		if (sec) {
			var date = new Date();
			date.setTime(date.getTime()+(sec*1000));
			var expires = "; expires="+date.toGMTString();
		}
		else var expires = "";
		document.cookie = name+"="+value+expires+"; path=/";
	}
	
	function deleteCookie(name) {
		createCookie(name,"",-1);
	}
	
	function extract_number(strString){
		var strValidChars = "0123456789.-";
		var strChar;
		var returnString = "";
		var i;
		
		if (strString.length == 0) return false;
	
		for (i = 0; i < strString.length; i++){
			strChar = strString.charAt(i);
			if(strValidChars.indexOf(strChar) > -1) returnString += strChar;
		}
		return parseFloat(returnString);
	}
	
	function extract_alpha(strString){
		var strNonAlphaChars = "0123456789.-";
		var strChar;
		var returnString = "";
		var i;
		
		if (strString.length == 0) return false;
	
		for (i = 0; i < strString.length; i++){
			strChar = strString.charAt(i);
			if(strNonAlphaChars.indexOf(strChar) == -1) returnString += strChar;
		}
		return returnString;
	}
	
	function getCookie(Name){ 
		var re=new RegExp(Name+"=[^;]+", "i"); //construct RE to search for target name/value pair
		if (document.cookie.match(re)) //if cookie found
			return document.cookie.match(re)[0].split("=")[1] //return its value
		return false;
	}
	
	function getWindowHeight(){
		var y = 0;
		if (self.innerHeight) {
			y = self.innerHeight;
		} else if (document.documentElement && document.documentElement.clientHeight) {
			y = document.documentElement.clientHeight;
		} else if (document.body) {
			y = document.body.clientHeight;
		}
	
		return y;
	}
	
	function getWindowWidth(){
		var x = 0;
		if (self.innerHeight) {
			x = self.innerWidth;
		} else if (document.documentElement && document.documentElement.clientHeight) {
			x = document.documentElement.clientWidth;
		} else if (document.body) {
			x = document.body.clientWidth;
		}
		
		return x;
	}
	
	function has_numeric(strString){
		var strValidChars = "0123456789.-";
		var strChar;
		var blnResult = false;
		var i;
		
		if (strString.length == 0) return false;
	
		//  test strString consists of valid characters listed above
		for (i = 0; i < strString.length && blnResult == false; i++){
			strChar = strString.charAt(i);
			if (strValidChars.indexOf(strChar) > -1){
				blnResult = true;
			}
		}
		return blnResult;
	}
	
	function is_array(input){
		return typeof(input)=='object'&&(input instanceof Array);
	}
	
	function is_numeric(strString){
		var strValidChars = "0123456789.-";
		var strChar;
		var blnResult = true;
		var i;
		
		if (strString.length == 0) return false;
	
		//  test strString consists of valid characters listed above
		for (i = 0; i < strString.length && blnResult == true; i++){
			strChar = strString.charAt(i);
			if (strValidChars.indexOf(strChar) == -1){
				blnResult = false;
			}
		}
		return blnResult;
	}
	
	function on_ajax_request_return2(url){
		ajax_request(url, 'function=print_ui', 'ajax_fill_element', 'ui_div');
		if(auto_view_r_result){
			document.getElementById('r_call_view').submit();
		}
		window.status= '';
	}
	
	function open_text_in_new_window(){
		window.open('A.html','A','width=300, height=200');
	}
	
	function parse_style_string(string){
	
		style_array = new Array();
		string_split1 = string.split(";");
	
		for(i in string_split1){
			if(string_split1[i] == "") continue;
			string_split2 = string_split1[i].split(":");
			style_array[string_split2[0]] = string_split2[1];
		}
	
		return style_array; 
	}
	
	function pixel_to_font_size(pixel_height){
		return pixel_height*1.43;
	}
	
	function sortasc(a,b){
		return a - b;
	}
	
	function toggle_div_visibility(id){
		div = document.getElementById(id);
		if(div.style.visibility == 'hidden'){
			div.style.visibility = '';
			div.style.height = '';
			//div.style.width = new_width + 'px';
		}else{
			div.style.visibility = 'hidden';
			div.style.height = '0px';
			div.style.width = '0px';
		}
	}
	
	function trim(stringToTrim){
		//http://www.somacon.com/p355.php
		return stringToTrim.replace(/^\s+|\s+$/g,"");
	}
	
	function ltrim(stringToTrim){
		//http://www.somacon.com/p355.php
		return stringToTrim.replace(/^\s+/,"");
	}
	
	function rtrim(stringToTrim){
		//http://www.somacon.com/p355.php
		return stringToTrim.replace(/\s+$/,"");
	}
</script>
